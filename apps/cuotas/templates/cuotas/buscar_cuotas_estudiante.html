{% extends 'base.html' %}
{% load static %}

{% block title %}Estado de Cuotas de Alumnos{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'cuotas/css/buscar_cuotas.css' %}">
{% endblock %}

{% block content %}
<article class="estado-cuotas">
  <div class="estado-cuotas__contenedor">
    <!-- Sección de Búsqueda -->
    <section class="estado-cuotas__busqueda">
      <form method="post" class="estado-cuotas__formulario">
        {% csrf_token %}

        <div class="estado-cuotas__buscador">
          <div class="estado-cuotas__grupo grupo-1">
            <label for="cuil" class="estado-cuotas__etiqueta">CUIL del Estudiante:</label>
            <!-- Si el CUIL está presente en la URL, lo ponemos en el campo -->
            <input type="text" id="cuil" name="cuil_estudiante" required class="estado-cuotas__input" 
            value="{% if request.GET.cuil %}{{ request.GET.cuil }}{% endif %}">        
          </div>        
          <div class="estado-cuotas__grupo grupo-2">
            <label for="ciclo_lectivo" class="estado-cuotas__etiqueta">Ciclo lectivo:</label>
            <select name="ciclo_lectivo" id="ciclo_lectivo" required class="estado-cuotas__select">
              <option value="">Seleccionar año</option>
              {% for ciclo in ciclos_lectivos %}
                <option value="{{ ciclo.id }}" {% if ciclo.id == ciclo_seleccionado %}selected{% endif %}>
                  {{ ciclo.año_lectivo }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>
        <button type="submit" class="boton-accion">
          <span class="boton-accion__circulo" aria-hidden="true">
            <span class="boton-accion__icono boton-accion__icono--flecha"></span>
          </span>
          <span class="boton-accion__texto">Buscar</span>
        </button>
      </form>
    </section>

    <!-- Sección de Resultados -->
    <section class="estado-cuotas__resultados">
      <h2 class="titulo-secundario">Resultado:</h2>
      <!-- Mensaje antes de la búsqueda -->
      {% if not request.POST.cuil_estudiante %}
        <p class="consulta-alumno__mensaje-info">Aún no se ha realizado ninguna búsqueda.</p>
      {% endif %}
      {% if estudiante %}
        <div class="estado-cuotas__titulo">
          <strong>Estudiante:</strong> {{ estudiante.apellidos_estudiante }}, {{ estudiante.nombres_estudiante }}
        </div>
      {% endif %}

      {% if inscripcion %}
        <p class="estado-cuotas__info">
          <strong>Subnivel:</strong> {{ inscripcion.subnivel_cursado.nombre }}
        </p>

        <h3 class="estado-cuotas__subtitulo">
          Cuotas del Ciclo {{ inscripcion.ciclo_lectivo.año_lectivo }}
        </h3>

        <table class="estado-cuotas__tabla">
          <thead>
            <tr>
              <th>Mes</th>
              <th>Monto</th>
              <th>Pagado</th>
              <th>Fecha de Pago</th>
              <th>Fuera de Término</th>
              <th>Interés</th>
              <th>Total a Pagar</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for cuota in cuotas %}
            <tr>
              <td>{{ cuota.mes }}</td>
              <td>${{ cuota.monto_cuota }}</td>
              <td>{{ cuota.pagado|yesno:"Sí,No" }}</td>
              <td>{{ cuota.fecha_pago|default:"-" }}</td>
              <td>{{ cuota.fuera_de_termino|yesno:"Sí,No" }}</td>
              <td>${{ cuota.interes_aplicado }}</td>
              <td>${{ cuota.total_a_pagar }}</td>
              <td>
                {% if cuota.pagado %}
                  <span class="text-success">Pagada</span>
                  <form action="{% url 'cuotas:deshacer_pago' cuota.id %}" method="post" style="display:inline;">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('¿Seguro que deseas deshacer este pago?');">
                          Deshacer pago
                      </button>
                  </form>
                {% else %}
                    <a href="{% url 'cuotas:realizar_pago' cuota.id %}" class="btn btn-primary btn-sm">Pagar</a>
                {% endif %}
            </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

      {% elif not inscripcion and request.POST.cuil_estudiante %}
        <p class="estado-cuotas__mensaje-error">
          Este estudiante no tiene inscripción en el ciclo lectivo ingresado.
        </p>
      {% endif %}
    </section>
  </div>
</article>

{% if messages %}
  <div class="toast-mensaje" id="toastMensaje">
    {% for message in messages %}
      <div class="toast-mensaje__alerta {{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
{% endif %}

<script>
  // Obtener el parámetro 'cuil' de la URL
  const urlParams = new URLSearchParams(window.location.search);
  const cuil = urlParams.get('cuil');

  // Si existe el CUIL en la URL, ponerlo automáticamente en el campo de búsqueda
  if (cuil) {
      document.getElementById('cuil').value = cuil;
  }

  window.addEventListener("load", () => {
    const toast = document.getElementById("toastMensaje");
    if (toast) {
      setTimeout(() => {
        toast.remove();
      }, 5000); // 5 segundos
    }
  });
</script>

{% endblock %}
