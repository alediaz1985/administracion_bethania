{% extends "base.html" %}
{% load static %}

{% block title %}Comprobantes & Documentos{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- Encabezado -->
  <div class="d-flex align-items-center justify-content-between mb-4">
    <div>
      <h2 class="m-0">Comprobantes & Documentos</h2>
      <p class="text-muted mb-0">Centro de acciones: b√∫squeda, subida y sincronizaci√≥n con Google Drive (AJAX).</p>
    </div>
    <!-- Bot√≥n ‚ÄúListar (JSON)‚Äù con selector de origen -->
    <div class="d-flex gap-2">
      <select id="select-listar-label" class="form-control form-control-sm" style="width:auto;">
        {% for label, cfg in sources.items %}
          <option value="{{ label }}">{{ label }}</option>
        {% endfor %}
      </select>
      <a id="btn-listar-json" href="#" target="_blank" class="btn btn-outline-secondary btn-sm" data-toggle="tooltip" title="Ver JSON con archivos en la carpeta seleccionada">
        <i class="bi bi-code"></i> Listar (JSON)
      </a>
    </div>
  </div>

  <!-- Grid de acciones -->
  <div class="row g-3">

    <!-- Buscar local (AJAX) -->
    <div class="col-12 col-md-6 col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center mb-2">
            <div class="mr-2 h4"><i class="bi bi-search"></i></div>
            <h5 class="card-title mb-0">B√∫squeda local</h5>
          </div>
          <p class="text-muted mb-3">
            Busca por nombre en tus archivos ya descargados en <code>MEDIA_ROOT</code>.
          </p>
          <form id="form-consulta" class="mt-auto">
            <div class="mb-2">
              <input type="text" name="q" class="form-control form-control-sm" placeholder="Ej: 12345678901, factura, 2025-10‚Ä¶" required>
            </div>
            <div class="d-flex gap-2">
              <select name="label" class="form-control form-control-sm">
                <option value="">Todos</option>
                {% for label, cfg in sources.items %}
                  <option value="{{ label }}">{{ label }}</option>
                {% endfor %}
              </select>
              <button id="btn-consultar" class="btn btn-primary btn-sm w-100" type="submit">
                <i class="bi bi-search"></i> Consultar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Buscar en Drive (AJAX: lista) -->
    <div class="col-12 col-md-6 col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center mb-2">
            <div class="mr-2 h4"><i class="bi bi-cloud-check"></i></div>
            <h5 class="card-title mb-0">B√∫squeda en Google Drive</h5>
          </div>
          <p class="text-muted mb-3">Lista los archivos de la carpeta seleccionada en Google Drive.</p>
          <div class="mt-auto d-flex gap-2">
            <select id="select-listar-ajax-label" class="form-control form-control-sm">
              {% for label, cfg in sources.items %}
                <option value="{{ label }}">{{ label }}</option>
              {% endfor %}
            </select>
            <button class="btn btn-outline-secondary btn-sm w-100" id="btn-listar-ajax">
              <i class="bi bi-list-ul"></i> Listar ahora
            </button>
          </div>
          <div class="small text-muted mt-2">
            <strong>Destino:</strong> muestra solo metadatos en Drive (no descarga).
          </div>
        </div>
      </div>
    </div>

    <!-- Subir comprobante -->
    <div class="col-12 col-md-6 col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center mb-2">
            <div class="mr-2 h4"><i class="bi bi-upload"></i></div>
            <h5 class="card-title mb-0">Subir comprobante</h5>
          </div>
          <p class="text-muted mb-3">Carga manual de comprobantes al servidor.</p>
          <div class="mt-auto">
            <a href="{% url 'comprobantes:subir_comprobante' %}" class="btn btn-outline-primary w-100">
              Subir ahora
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Descargar desde Drive -->
    <div class="col-12 col-md-6 col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center mb-2">
            <div class="mr-2 h4"><i class="bi bi-download"></i></div>
            <h5 class="card-title mb-0">Descargar desde Google Drive</h5>
          </div>
          <p class="text-muted mb-3">
            Descarga nuevos archivos a <code>/media/documentos/&lt;dest_subpath&gt;/&lt;label&gt;/</code>.
          </p>

          <div class="d-flex gap-2">
            <select id="select-descargar-label" class="form-control form-control-sm">
              {% for label, cfg in sources.items %}
                <option value="{{ label }}">{{ label }}</option>
              {% endfor %}
            </select>
            <button class="btn btn-success btn-sm w-100" data-toggle="modal" data-target="#modalDescargar">
              Descargar ahora
            </button>
          </div>

          <!-- Modal confirmar descarga -->
          <div class="modal fade" id="modalDescargar" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title"><i class="bi bi-download"></i> Confirmar descarga</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  ¬øDese√°s descargar los archivos desde Google Drive? Se omitir√°n los que ya existan con el mismo nombre destino.
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-light" data-dismiss="modal">Cancelar</button>
                  <button id="btn-confirmar-descarga" type="button" class="btn btn-success">S√≠, descargar</button>
                </div>
              </div>
            </div>
          </div>

          <a href="{% url 'comprobantes:exito_descarga' %}" class="btn btn-link mt-2 w-100">
            Ver √∫ltimo resumen
          </a>
        </div>
      </div>
    </div>

    <!-- Vaciar carpeta de Drive -->
    <div class="col-12 col-md-6 col-xl-4">
      <div class="card shadow-sm h-100 border-danger">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center mb-2">
            <div class="mr-2 h4 text-danger"><i class="bi bi-trash"></i></div>
            <h5 class="card-title mb-0 text-danger">Vaciar carpeta de Drive</h5>
          </div>
          <p class="text-muted mb-3">
            <strong>Acci√≥n destructiva:</strong> elimina <u>todos</u> los archivos de la carpeta remota (no del servidor).
          </p>

          <div class="d-flex gap-2">
            <select id="select-vaciar-label" class="form-control form-control-sm">
              {% for label, cfg in sources.items %}
                <option value="{{ label }}">{{ label }}</option>
              {% endfor %}
            </select>
            <button class="btn btn-outline-danger btn-sm w-100" data-toggle="modal" data-target="#modalVaciar">
              Vaciar carpeta
            </button>
          </div>

          <!-- Modal confirmar vaciado -->
          <div class="modal fade" id="modalVaciar" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Confirmar vaciado</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  Esta acci√≥n eliminar√° <strong>todos</strong> los archivos de la carpeta de Google Drive seleccionada. ¬øSeguro?
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-light" data-dismiss="modal">Cancelar</button>
                  <button id="btn-confirmar-vaciar" type="button" class="btn btn-danger">S√≠, vaciar</button>
                </div>
              </div>
            </div>
          </div>

          <div class="small text-muted mt-2">
            Consejo: hac√© un backup antes de vaciar.
          </div>
        </div>
      </div>
    </div>

    <!-- Ayuda / Documentaci√≥n -->
    <div class="col-12 col-md-6 col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center mb-2">
            <div class="mr-2 h4"><i class="bi bi-info-circle"></i></div>
            <h5 class="card-title mb-0">Ayuda r√°pida</h5>
          </div>
          <ul class="text-muted small mb-3">
            <li><strong>B√∫squeda local:</strong> inspecciona archivos guardados en el servidor.</li>
            <li><strong>Drive:</strong> Listar muestra metadatos; Descargar guarda en <code>MEDIA_ROOT</code>.</li>
            <li><strong>Vaciar Drive:</strong> elimina archivos remotos (requiere scope de escritura).</li>
          </ul>
          <div class="mt-auto">
            <a href="{% url 'comprobantes:consulta' %}" class="btn btn-light w-100">Ver m√°s opciones</a>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /row -->

  <!-- Resultados -->
  <hr class="my-4">
  <div id="resultados"></div>

  <!-- Spinner global -->
  <div id="spinner-global" class="text-center mt-4" style="display:none;">
    <div class="spinner-border" role="status" aria-hidden="true"></div>
    <div class="small text-muted mt-2">Procesando‚Ä¶</div>
  </div>

</div>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<!-- jQuery + Popper + Bootstrap 4 JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.6.2/js/bootstrap.min.js"></script>

<script>
  // ===== Tooltips (Bootstrap 4)
  $(function () {
    $('[data-toggle="tooltip"]').tooltip();
  });

  // ===== CSRF
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  function showSpinner(show=true) {
    $('#spinner-global').toggle(show);
  }
  function disableButtons(disabled=true) {
    $('#btn-consultar, #btn-listar-ajax, #btn-confirmar-descarga, #btn-confirmar-vaciar, #btn-listar-json').prop('disabled', disabled);
  }

  // ===== Render helpers (id√©nticos a antes)
  function renderListFiles(payload) {
    const files = payload.files || [];
    let html = `<div class="mb-4"><h4 class="text-secondary">üìã Archivos en Google Drive (${payload.label})</h4><p class="small text-muted">Carpeta: <code>${payload.folder_id}</code> | Fecha: ${payload.fecha}</p>`;
    if (payload.error) {
      html += `<div class="alert alert-danger">${payload.error}</div>`;
    } else if (files.length) {
      html += `<ul class="list-group small">` +
        files.map(f => `<li class="list-group-item d-flex justify-content-between align-items-center"><span>${f.name}</span><code>${f.id}</code></li>`).join('') +
        `</ul>`;
    } else {
      html += `<div class="alert alert-info">No se encontraron archivos.</div>`;
    }
    html += `</div>`;
    return html;
  }

  function renderDescarga(payload) {
    let html = `<div class="mb-4"><h4 class="text-primary">üì• Descarga desde Drive (${payload.label})</h4><p class="text-muted small">Fecha: ${payload.fecha} | Carpeta ID: <code>${payload.folder_id}</code></p>`;
    if (payload.descargados?.length) {
      html += `<div class="alert alert-success"><strong>Descargados (${payload.descargados.length}):</strong><ul class="mb-0 small">${payload.descargados.map(x => `<li>${x}</li>`).join('')}</ul></div>`;
    }
    if (payload.omitidos?.length) {
      html += `<div class="alert alert-warning"><strong>Omitidos (${payload.omitidos.length}):</strong><ul class="mb-0 small">${payload.omitidos.map(x => `<li>${x}</li>`).join('')}</ul></div>`;
    }
    if (payload.errores?.length) {
      html += `<div class="alert alert-danger"><strong>Errores:</strong><ul class="mb-0 small">${payload.errores.map(x => `<li>${x}</li>`).join('')}</ul></div>`;
    }
    html += `</div>`;
    return html;
  }

  function renderVaciar(payload) {
    return `<div class="mb-4"><h4 class="text-danger">üóëÔ∏è Resultado de vaciado</h4><p class="small text-muted">Carpeta: <code>${payload.folder_id}</code> | Fecha: ${payload.fecha}</p><div class="alert alert-info mb-0">${payload.mensaje}</div></div>`;
  }

  function renderConsulta(payload) {
    let html = `<div class="mb-4"><h4 class="text-success">üîç Consulta local</h4><p class="small text-muted">T√©rmino: <code>${payload.q}</code> | Origen: ${payload.label}</p>`;
    if (payload.error) {
      html += `<div class="alert alert-danger">${payload.error}</div>`;
    } else if (payload.resultados?.length) {
      html += `<ul class="small">${payload.resultados.map(r => `<li><strong>${r.archivo}</strong> ‚Äî ${r.ruta}</li>`).join('')}</ul>`;
    } else {
      html += `<div class="alert alert-info">Sin coincidencias.</div>`;
    }
    html += `</div>`;
    return html;
  }

  function appendResult(html) {
    $('#resultados').prepend(html);
  }

  async function doGet(url) {
    showSpinner(true); disableButtons(true);
    try {
      const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      return await resp.json();
    } finally {
      showSpinner(false); disableButtons(false);
    }
  }

  // ===== Acciones =====

  $('#btn-listar-json').on('click', function(e) {
    e.preventDefault();
    const label = $('#select-listar-label').val();
    const url = `{% url 'comprobantes:list_files' %}?label=${encodeURIComponent(label)}&ajax=1`;
    window.open(url, '_blank');
  });

  $('#btn-listar-ajax').on('click', async function() {
    const label = $('#select-listar-ajax-label').val();
    const url = `{% url 'comprobantes:list_files' %}?label=${encodeURIComponent(label)}&ajax=1`;
    const data = await doGet(url);
    appendResult(renderListFiles(data));
  });

  $('#form-consulta').on('submit', async function(e) {
    e.preventDefault();
    const q = $('input[name="q"]').val();
    const label = $('select[name="label"]').val();
    const url = `{% url 'comprobantes:consulta' %}?q=${encodeURIComponent(q)}&label=${encodeURIComponent(label)}&ajax=1`;
    const data = await doGet(url);
    appendResult(renderConsulta(data));
  });

  $('#btn-confirmar-descarga').on('click', async function() {
    const label = $('#select-descargar-label').val();
    const url = `{% url 'comprobantes:descargar_archivos_nube' %}?label=${encodeURIComponent(label)}&ajax=1`;
    const data = await doGet(url);
    appendResult(renderDescarga(data));
    $('#modalDescargar').modal('hide');
  });

  $('#btn-confirmar-vaciar').on('click', async function() {
    const label = $('#select-vaciar-label').val();
    if (!confirm(`¬øVaciar carpeta ${label} en Drive? Esta acci√≥n es irreversible.`)) return;
    const url = `{% url 'comprobantes:vaciar_carpeta_drive' %}?label=${encodeURIComponent(label)}&ajax=1`;
    const data = await doGet(url);
    appendResult(renderVaciar(data));
    $('#modalVaciar').modal('hide');
  });
</script>
{% endblock %}
