{% extends 'base.html' %}
{% load static %}

{% block title %}Becas y Beneficios{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>ðŸŽ“ Becas y Beneficios</h2>
    <button class="btn btn-primary" id="btnAddBeca">âž• Nueva Beca</button>
  </div>

  <div id="tabla-becas">
    {% include 'administracion/beca/_tabla.html' %}
  </div>
</div>

<!-- Modal Bootstrap -->
<div id="modalBeca" class="modal fade" tabindex="-1" aria-hidden="true"></div>
{% endblock %}

{% block extra_js %}
<script>
  function loadModal(url) {
    fetch(url)
      .then(r => r.json())
      .then(data => {
        const modalDiv = document.getElementById("modalBeca");
        modalDiv.innerHTML = data.html_form;

        // Crear instancia de modal
        const modal = new bootstrap.Modal(modalDiv);
        modal.show();

        // FunciÃ³n para manejar el envÃ­o del form
        function handleSubmit(form) {
          form.addEventListener("submit", function (e) {
            e.preventDefault();
            fetch(url, { method: "POST", body: new FormData(form) })
              .then(r => r.json())
              .then(data => {
                if (data.form_is_valid) {
                  document.getElementById("tabla-becas").innerHTML = data.html_list;
                  modal.hide(); // âœ… Solo se cierra si es vÃ¡lido
                } else {
                  // ðŸ” Reemplazamos solo el contenido del modal, no lo destruimos
                  modalDiv.innerHTML = data.html_form;

                  // âœ… Volvemos a vincular el nuevo form (porque se recreÃ³)
                  const newForm = modalDiv.querySelector("form");
                  handleSubmit(newForm);
                }
              });
          });
        }

        // Asignar el primer form al cargar
        const form = modalDiv.querySelector("form");
        if (form) handleSubmit(form);
      });
  }

  // Crear
  document.getElementById("btnAddBeca").addEventListener("click", () => {
    loadModal("{% url 'administracion:crear_beca' %}");
  });

  // Editar / Eliminar (delegaciÃ³n)
  document.addEventListener("click", (e) => {
    const editBtn = e.target.closest(".js-edit");
    if (editBtn) loadModal(editBtn.dataset.url);

    const delBtn = e.target.closest(".js-delete");
    if (delBtn) loadModal(delBtn.dataset.url);
  });
</script>
{% endblock %}
