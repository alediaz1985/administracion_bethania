{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}">
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="dashboard-wrapper" data-aos="fade-in">
  <h1 class="titulo-dashboard" data-aos="fade-down">ðŸ“Š Panel de Control</h1>

  <!-- ============ TARJETAS KPI (clicables) ============ -->
  <div class="cards-container">
    <a class="card-link" href="{% url 'dashboard:lista_estudiantes' %}">
      <div class="card" data-aos="fade-up">
        <i data-lucide="users"></i>
        <div class="kpi-title">Estudiantes</div>
        <div class="kpi-value">{{ total_estudiantes }}</div>
      </div>
    </a>

    <a class="card-link" href="{% url 'dashboard:lista_inscripciones' %}">
      <div class="card" data-aos="fade-up" data-aos-delay="100">
        <i data-lucide="id-card"></i>
        <div class="kpi-title">Con InscripciÃ³n</div>
        <div class="kpi-value">{{ total_con_inscripcion }}</div>
      </div>
    </a>

    <a class="card-link" href="{% url 'dashboard:lista_estudiantes' %}?f=doc:aprobado">
      <div class="card" data-aos="fade-up" data-aos-delay="200">
        <i data-lucide="check-circle-2"></i>
        <div class="kpi-title">DocumentaciÃ³n Aprobada</div>
        <div class="kpi-value">{{ aprobados }} ({{ porc_aprobado }}%)</div>
      </div>
    </a>

    <a class="card-link" href="{% url 'dashboard:lista_estudiantes' %}?f=doc:pendiente">
      <div class="card" data-aos="fade-up" data-aos-delay="300">
        <i data-lucide="hourglass"></i>
        <div class="kpi-title">Pendientes</div>
        <div class="kpi-value">{{ pendientes }} ({{ porc_pendiente }}%)</div>
      </div>
    </a>

    <a class="card-link" href="{% url 'dashboard:lista_inscripciones' %}?fotos=pendientes">
      <div class="card" data-aos="fade-up" data-aos-delay="400">
        <i data-lucide="image-off"></i>
        <div class="kpi-title">Fotos faltantes</div>
        <div class="kpi-value">{{ fotos_pendientes }}</div>
      </div>
    </a>

    <a class="card-link" href="{% url 'dashboard:lista_contactos' %}?incompletos=1">
      <div class="card" data-aos="fade-up" data-aos-delay="500">
        <i data-lucide="phone-off"></i>
        <div class="kpi-title">Contacto incompleto</div>
        <div class="kpi-value">{{ contacto_incompleto }}</div>
      </div>
    </a>
  </div>

  <!-- ============ GRÃFICOS ============ -->
  <div class="charts-grid">
    <div class="chart-card" data-aos="zoom-in-up">
      <div class="chart-title">Estudiantes por Nivel</div>
      <div class="chart-canvas"><canvas id="chartNiveles"></canvas></div>
    </div>

    <div class="chart-card" data-aos="zoom-in-up" data-aos-delay="100">
      <div class="chart-title">Turnos</div>
      <div class="chart-canvas"><canvas id="chartTurnos"></canvas></div>
    </div>

    <div class="chart-card" data-aos="zoom-in-up" data-aos-delay="200">
      <div class="chart-title">Top 5 Ciudades</div>
      <div class="chart-canvas"><canvas id="chartCiudades"></canvas></div>
    </div>
  </div>

  <!-- ============ TABLA ============ -->
  <div class="table-card" data-aos="fade-up" data-aos-delay="300">
    <div class="table-title">Ãšltimos Estudiantes</div>
    <div class="table-responsive">
      <table class="nice-table">
        <thead>
          <tr>
            <th>Apellido/s</th>
            <th>Nombre/s</th>
            <th>CUIL</th>
            <th style="width:1%"></th>
          </tr>
        </thead>
        <tbody>
          {% for e in ultimos_estudiantes %}
          <tr>
            <td>{% firstof e.apellidos_estudiante e.apellidos e.last_name "â€”" %}</td>
            <td>{% firstof e.nombres_estudiante e.nombres e.first_name "â€”" %}</td>
            <td>{% firstof e.cuil_estudiante e.documento "â€”" %}</td>
            <td>
              <a class="btn btn-sm btn-outline-primary"
                 href="{% url 'dashboard:lista_estudiantes' %}?q={% firstof e.cuil_estudiante e.documento e.id %}">
                 Ver en listado
              </a>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="4" class="empty">No hay estudiantes.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ======= Datos seguros para JS (usando el filtro json_script) ======= -->
{{ niveles_labels|json_script:"niveles-labels" }}
{{ niveles_data|json_script:"niveles-data" }}
{{ turnos_labels|json_script:"turnos-labels" }}
{{ turnos_data|json_script:"turnos-data" }}
{{ ciudades_labels|json_script:"ciudades-labels" }}
{{ ciudades_data|json_script:"ciudades-data" }}

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script src="{% static 'dashboard/js/dashboard.js' %}"></script>
{% endblock %}
