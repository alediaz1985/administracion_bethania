{% extends 'base.html' %}
{% load static %}

{% block title %}Ficha del Estudiante{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'administracion_alumnos/css/styles_ver_datos.css' %}">
{% endblock %}

{% block content %}
<div class="student-card">

  <!-- üîî Contenedor de notificaciones flotantes -->
  <div id="toast-container">
    {% if messages %}
      {% for message in messages %}
        <div class="toast-message {{ message.tags }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  </div>

  <!-- CABECERA -->
  <div class="student-header">
    <!-- Foto -->
    <img src="{{ image_url }}" alt="Foto del Estudiante" class="student-photo">

    <!-- Informaci√≥n -->
    <div class="student-info">
      <h2>{{ estudiante.apellidos_estudiante }}, {{ estudiante.nombres_estudiante }}</h2>
      <p><strong>DNI:</strong> {{ estudiante.dni_estudiante }}</p>
      <p><strong>CUIL:</strong> {{ estudiante.cuil_estudiante }}</p>
    </div>

    <!-- Bot√≥n / Mensaje Inscripci√≥n -->
    <div class="student-inscripcion">
      {% if estudiante.inscripciones_admin.exists %}
        <div class="inscripcion-estado">
          ‚úÖ Alumno inscripto en el ciclo {{ estudiante.inscripciones_admin.last.ciclo.anio }}
        </div>
        <!-- üîò Bot√≥n que abre el modal -->
        <button type="button"
                class="btn-eliminar"
                id="abrirModalEliminar"
                data-inscripcion-id="{{ estudiante.inscripciones_admin.last.id }}"
                data-estudiante="{{ estudiante.apellidos_estudiante }}, {{ estudiante.nombres_estudiante }}">
          Eliminar inscripci√≥n
        </button>
      {% else %}
        <a href="{% url 'administracion:inscribir_estudiante' estudiante.id %}" class="btn-inscribir">
          Inscribir Estudiante
        </a>
      {% endif %}
    </div>
  </div>

  <!-- BOTONES -->
  <div class="student-actions">
    <a href="{% url 'generar_pdf_estudiante' estudiante_id=estudiante.id %}" class="btn">Generar PDF</a>
    <button type="button" id="btnDescargarArchivos" class="btn">Archivos</button>
    <a href="{% url 'estudiante_edit' pk=estudiante.id %}" class="btn">Editar</a>
      {% if estudiante.estado_documentacion.estado|lower == 'pendiente' %}
        <button type="button" class="btn btn-success" id="abrirModalEstado"
                data-accion="aprobar" data-color="success" data-nuevo="aprobado">
          Aprobar Doc.
        </button>
      {% elif estudiante.estado_documentacion.estado|lower == 'aprobado' %}
        <button type="button" class="btn btn-warning" id="abrirModalEstado"
                data-accion="marcar como pendiente" data-color="warning" data-nuevo="pendiente">
          Marcar Pendiente
        </button>
      {% endif %}
    <a href="{% url 'estudiante_list' %}" class="btn btn-light">Volver</a>
  </div>

  <!-- PESTA√ëAS -->
  <div class="tabs">
    <button type="button" class="tab-button active" data-tab="datos">Datos Personales</button>
    <button type="button" class="tab-button" data-tab="inscripcion">Inscripci√≥n</button>
    <button type="button" class="tab-button" data-tab="academica">Acad√©mica</button>
    <button type="button" class="tab-button" data-tab="contacto">Contacto</button>
    <button type="button" class="tab-button" data-tab="salud">Salud</button>
    <button type="button" class="tab-button" data-tab="responsables">Responsables</button>
    <button type="button" class="tab-button" data-tab="documentacion">Documentaci√≥n</button>
    <button type="button" class="tab-button" data-tab="cuotas">Cuotas</button>
    <button type="button" class="tab-button" data-tab="estado">Estado Doc.</button>
  </div>

  <!-- ===== DATOS PERSONALES ===== -->
  <div class="tab-content active" id="tab-datos">
    <table>
      <tr><th>Apellidos</th><td>{{ estudiante.apellidos_estudiante }}</td></tr>
      <tr><th>Nombres</th><td>{{ estudiante.nombres_estudiante }}</td></tr>
      <tr><th>Sexo</th><td>{{ estudiante.sexo_estudiante }}</td></tr>
      <tr><th>Fecha de Nacimiento</th><td>{{ estudiante.fecha_nac_estudiante }}</td></tr>
      <tr><th>Nacionalidad</th><td>{{ estudiante.nacionalidad_estudiante }}</td></tr>
      <tr><th>Religi√≥n</th><td>{{ estudiante.religion_estudiante }}</td></tr>
      <tr><th>CUIL</th><td>{{ estudiante.cuil_estudiante }}</td></tr>
      <tr><th>DNI</th><td>{{ estudiante.dni_estudiante }}</td></tr>
    </table>
  </div>

  <!-- ===== INSCRIPCI√ìN ===== -->
  <div class="tab-content" id="tab-inscripcion">
    {% if estudiante.inscripcion %}
    <table>
      <tr><th>Marca Temporal</th><td>{{ estudiante.inscripcion.marca_temporal }}</td></tr>
      <tr><th>Email Registro</th><td>{{ estudiante.inscripcion.email_registro }}</td></tr>
      <tr><th>Foto</th><td>{{ estudiante.inscripcion.foto_estudiante }}</td></tr>
      <tr><th>N¬∞ Legajo</th><td>{{ estudiante.inscripcion.num_legajo_estudiante }}</td></tr>
      <tr><th>Fecha Recepci√≥n</th><td>{{ estudiante.inscripcion.fecha_recepcion }}</td></tr>
      <tr><th>Salita / Grado / A√±o</th><td>{{ estudiante.inscripcion.salita_grado_anio_estudiante }}</td></tr>
      <tr><th>Nivel</th><td>{{ estudiante.inscripcion.nivel_estudiante }}</td></tr>
      <tr><th>Curso / A√±o</th><td>{{ estudiante.inscripcion.curso_anio_estudiante }}</td></tr>
      <tr><th>Turno</th><td>{{ estudiante.inscripcion.turno_estudiante }}</td></tr>
      <tr><th>Nivel de Ense√±anza</th><td>{{ estudiante.inscripcion.nivel_ensenanza }}</td></tr>
    </table>
    {% else %}
    <p>No hay datos de inscripci√≥n.</p>
    {% endif %}
  </div>

  <!-- ===== INFORMACI√ìN ACAD√âMICA ===== -->
  <div class="tab-content" id="tab-academica">
    {% if estudiante.info_academica %}
    <table>
      <tr><th>A√±o Cursado</th><td>{{ estudiante.info_academica.anio_cursado }}</td></tr>
      <tr><th>D√≥nde Curs√≥</th><td>{{ estudiante.info_academica.donde_cursado }}</td></tr>
      <tr><th>Asignaturas Pendientes</th><td>{{ estudiante.info_academica.asignaturas_pendientes }}</td></tr>
      <tr><th>Indica Cu√°les</th><td>{{ estudiante.info_academica.indica_asig_pendientes }}</td></tr>
      <tr><th>Tiene Hermanos en la Instituci√≥n</th><td>{{ estudiante.info_academica.tiene_hermanos_institucion }}</td></tr>
      <tr><th>Cu√°ntos Hermanos</th><td>{{ estudiante.info_academica.cuantos_hermanos }}</td></tr>
      <tr><th>C√≥mo conoci√≥ la instituci√≥n</th><td>{{ estudiante.info_academica.como_conociste_institucion }}</td></tr>
      <tr><th>Qui√©n eligi√≥ la instituci√≥n</th><td>{{ estudiante.info_academica.eligio_institucion }}</td></tr>
    </table>
    {% else %}
    <p>No hay informaci√≥n acad√©mica.</p>
    {% endif %}
  </div>

  <!-- ===== CONTACTO ===== -->
  <div class="tab-content" id="tab-contacto">
    {% if estudiante.contacto %}
    <table>
      <tr><th>Ciudad</th><td>{{ estudiante.contacto.ciudad_estudiante }}</td></tr>
      <tr><th>Provincia</th><td>{{ estudiante.contacto.provincia_estudiante }}</td></tr>
      <tr><th>Barrio</th><td>{{ estudiante.contacto.barrio_estudiante }}</td></tr>
      <tr><th>Calle</th><td>{{ estudiante.contacto.calle_estudiante }}</td></tr>
      <tr><th>N¬∞ / Mz / Pc</th><td>{{ estudiante.contacto.n_mz_pc_estudiante }}</td></tr>
      <tr><th>C√≥digo Postal</th><td>{{ estudiante.contacto.codigo_postal_estudiante }}</td></tr>
      <tr><th>Email</th><td>{{ estudiante.contacto.email_estudiante }}</td></tr>
      <tr><th>Tel. Fijo</th><td>{{ estudiante.contacto.tel_fijo_estudiante }}</td></tr>
      <tr><th>Tel. Celular</th><td>{{ estudiante.contacto.tel_cel_estudiante }}</td></tr>
      <tr><th>Tel. Emergencia</th><td>{{ estudiante.contacto.tel_emergencia_estudiante }}</td></tr>
      <tr><th>Parentesco</th><td>{{ estudiante.contacto.parentesco_estudiante }}</td></tr>
    </table>
    {% else %}
    <p>No hay datos de contacto.</p>
    {% endif %}
  </div>

  <!-- ===== SALUD ===== -->
  <div class="tab-content" id="tab-salud">
    {% if estudiante.salud %}
    <table>
      <tr><th>Peso</th><td>{{ estudiante.salud.peso_estudiante }}</td></tr>
      <tr><th>Talla</th><td>{{ estudiante.salud.talla_estudiante }}</td></tr>
      <tr><th>Obra Social</th><td>{{ estudiante.salud.obra_social_estudiante }}</td></tr>
      <tr><th>Cu√°l</th><td>{{ estudiante.salud.cual_osocial_estudiante }}</td></tr>
      <tr><th>Problema Neurol√≥gico</th><td>{{ estudiante.salud.problema_neurologico_estudiante }}</td></tr>
      <tr><th>Cu√°l</th><td>{{ estudiante.salud.cual_prob_neurologico_estudiante }}</td></tr>
      <tr><th>Problema F√≠sico</th><td>{{ estudiante.salud.problema_fisico_estudiante }}</td></tr>
      <tr>
    <th>Certificado M√©dico</th>
    <td>
      {% if estudiante.salud.certificado_medico_estudiante %}
        <button type="button"
                class="btn btn-sm btn-primary"
                data-view-url="{% url 'ver_certificado_medico' estudiante.id %}"
                id="btn-ver-certificado">
          <i class="bi bi-file-earmark-pdf"></i> Ver certificado
        </button>

        <small class="text-muted ms-2 d-block d-md-inline text-break">
          {{ estudiante.salud.certificado_medico_estudiante }}
        </small>
      {% else %}
        <span class="text-muted">Sin certificado cargado</span>
      {% endif %}
    </td>
  </tr>

      <tr><th>Problema de Aprendizaje</th><td>{{ estudiante.salud.problema_aprendizaje_estudiante }}</td></tr>
      <tr><th>Cu√°l</th><td>{{ estudiante.salud.cual_aprendizaje_estudiante }}</td></tr>
      <tr><th>Atenci√≥n M√©dica</th><td>{{ estudiante.salud.atencion_medica_estudiante }}</td></tr>
      <tr><th>Alergias</th><td>{{ estudiante.salud.alergia_estudiante }}</td></tr>
    </table>
    {% else %}
    <p>No hay datos de salud.</p>
    {% endif %}
  </div>

  <!-- ===== RESPONSABLES ===== -->
  <div class="tab-content" id="tab-responsables">
    {% if estudiante.responsables.all %}
    {% for r in estudiante.responsables.all %}
    <h4>{{ r.apellidos }}, {{ r.nombres }}</h4>
    <table>
      <tr><th>DNI</th><td>{{ r.dni }}</td></tr>
      <tr><th>CUIL</th><td>{{ r.cuil }}</td></tr>
      <tr><th>Nacionalidad</th><td>{{ r.nacionalidad }}</td></tr>
      <tr><th>Fecha de Nacimiento</th><td>{{ r.fecha_nac }}</td></tr>
      <tr><th>Estado Civil</th><td>{{ r.estado_civil }}</td></tr>
      <tr><th>Nivel de Instrucci√≥n</th><td>{{ r.nivel_instruccion }}</td></tr>
      <tr><th>Religi√≥n</th><td>{{ r.religion }}</td></tr>
      <tr><th>Email</th><td>{{ r.email }}</td></tr>
      <tr><th>Tel. Fijo</th><td>{{ r.tel_fijo }}</td></tr>
      <tr><th>Tel. Celular</th><td>{{ r.tel_cel }}</td></tr>
      <tr><th>Tel. Laboral</th><td>{{ r.tel_laboral }}</td></tr>
      <tr><th>Horario de Trabajo</th><td>{{ r.horario_trabajo }}</td></tr>
      <tr><th>Ocupaci√≥n</th><td>{{ r.ocupacion }}</td></tr>
      <tr><th>Domicilio</th><td>{{ r.calle }} {{ r.n_mz_pc }}, {{ r.barrio }} - {{ r.ciudad }} ({{ r.codigo_postal }}), {{ r.provincia }}</td></tr>
    </table>
    <hr>
    {% endfor %}
    {% else %}
    <p>No hay responsables cargados.</p>
    {% endif %}
  </div>

  <!-- ===== DOCUMENTACI√ìN ===== -->
  <div class="tab-content" id="tab-documentacion">
    {% if estudiante.documentacion %}
    <table>
      <tr><th>Fecha Contrato</th><td>{{ estudiante.documentacion.fecha_contrato }}</td></tr>
      <tr><th>Ciudad a los D√≠as</th><td>{{ estudiante.documentacion.ciudad_a_los_dias }}</td></tr>
      <tr><th>Se√±ores 1</th><td>{{ estudiante.documentacion.senores1 }} (DNI {{ estudiante.documentacion.dni_senores1 }})</td></tr>
      <tr><th>Se√±ores 2</th><td>{{ estudiante.documentacion.senores2 }} (DNI {{ estudiante.documentacion.dni_senores2 }})</td></tr>
      <tr><th>Domicilios Se√±ores</th><td>{{ estudiante.documentacion.domicilios_senores }}</td></tr>
      <tr><th>Domicilio Especial Electr√≥nico</th><td>{{ estudiante.documentacion.domicilio_especial_electronico }}</td></tr>
      <tr><th>Act√∫an en nombre del Estudiante</th><td>{{ estudiante.documentacion.actuan_nombres_estudiante }} (DNI {{ estudiante.documentacion.dni_acutan_estudiante }})</td></tr>
      <tr><th>Domicilio de quien Act√∫a</th><td>{{ estudiante.documentacion.domicilio_actuan_estudiante }}</td></tr>
      <tr><th>Responsable de Pago</th><td>{{ estudiante.documentacion.responsable_pago }} (DNI {{ estudiante.documentacion.dni_responsable_pago }})</td></tr>
      <tr><th>Manifiesta Responsable</th><td>{{ estudiante.documentacion.manifiesta_responsable }}</td></tr>
      <tr><th>Autoriza Facturaci√≥n a</th><td>{{ estudiante.documentacion.autoriza_facturacion_a }}</td></tr>
      <tr><th>Autoriza Imagen</th><td>{{ estudiante.documentacion.autoriza_imagen }}</td></tr>
    </table>
    {% else %}
    <p>No hay documentaci√≥n registrada.</p>
    {% endif %}
  </div>

  <!-- ===== CUOTAS ===== -->
  <div class="tab-content" id="tab-cuotas">
    {% if cuotas %}

    <!-- üîπ MODAL PARA ELEGIR RANGO -->
    <div class="modal fade" id="modalGenerarPDF" tabindex="-1" aria-labelledby="modalGenerarPDFLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content form-modal">
          <div class="modal-header">
            <h5 class="modal-title" id="modalGenerarPDFLabel">Generar Estado de Deuda</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <form id="formGenerarPDF" method="GET" action="{% url 'administracion:generar_pdf_deuda' estudiante.id %}" target="_blank">

              <!-- üìÖ Selecci√≥n de rango -->
              <div class="rango-meses">
                <div>
                  <label for="desde">Desde</label>
                  <select name="desde" id="desde" class="form-select">
                    {% for mes in meses %}
                      <option value="{{ forloop.counter|add:2 }}">{{ mes }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label for="hasta">Hasta</label>
                  <select name="hasta" id="hasta" class="form-select">
                    {% for mes in meses %}
                      <option value="{{ forloop.counter|add:2 }}">{{ mes }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>

              <!-- ‚úÖ Checkbox -->
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="todas" name="todas">
                <label class="form-check-label" for="todas">Generar deuda completa</label>
              </div>

              <!-- üß≠ Botones -->
              <div class="modal-actions">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-success">
                  Generar PDF
                </button>
              </div>

            </form>
          </div>
        </div>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Mes</th>
          <th>A√±o</th>
          <th>Monto</th>
          <th>Estado</th>
          <th>Vencimiento</th>
          <th>Pago</th>
        </tr>
      </thead>
      <tbody>
        {% for cuota in cuotas %}
        <tr>
          <td>{{ cuota.mes }}</td>
          <td>{{ cuota.anio }}</td>
          <td>${{ cuota.monto_final }}</td>
          <td>
            {% if cuota.estado == 'Pagada' %}
              <span style="color:green; font-weight:bold;">Pagada</span>
            {% elif cuota.estado == 'Vencida' %}
              <span style="color:red; font-weight:bold;">Vencida</span>
            {% else %}
              <span style="color:orange; font-weight:bold;">Pendiente</span>
            {% endif %}
          </td>
          <td>{{ cuota.fecha_vencimiento|date:"d/m/Y" }}</td>
          <td>
            {% if cuota.estado == 'Pagada' %}
              <button type="button"
                      class="btn btn-warning btn-deshacer-pago"
                      data-cuota-id="{{ cuota.id }}"
                      data-estudiante="{{ estudiante.apellidos_estudiante }}, {{ estudiante.nombres_estudiante }}"
                      title="Deshacer Pago">
                <i class="fas fa-times"></i>
              </button>
            {% else %}
              <button type="button"
                      class="btn btn-light btn-registrar-pago"
                      data-cuota-id="{{ cuota.id }}"
                      data-monto="{{ cuota.monto_final }}"
                      data-mes="{{ cuota.mes }}"
                      data-anio="{{ cuota.anio }}"
                      data-estudiante="{{ estudiante.apellidos_estudiante }}, {{ estudiante.nombres_estudiante }}"
                      title="Registrar Pago">
                <i class="fas fa-cash-register"></i>
              </button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- üîπ BOT√ìN GENERAR PDF -->
    <div class="pdf-actions">
      <button class="btn-pdf" data-bs-toggle="modal" data-bs-target="#modalGenerarPDF">
        <i class="fas fa-file-pdf"></i> Generar Estado de Deuda
      </button>
    </div>
    {% else %}
      <p>No hay cuotas registradas.</p>
    {% endif %}
  </div>

  <!-- ===== ESTADO DE DOCUMENTACI√ìN ===== -->
  <div class="tab-content" id="tab-estado">
    {% if estudiante.estado_documentacion %}
    <div class="status {{ estudiante.estado_documentacion.estado|lower }}">
      <strong>Estado de Documentaci√≥n:</strong> {{ estudiante.estado_documentacion.estado }}<br>
      <span>√öltima actualizaci√≥n: {{ estudiante.estado_documentacion.fecha_actualizacion|date:"d/m/Y H:i" }}</span>
    </div>
    {% else %}
    <p>No hay estado de documentaci√≥n registrado.</p>
    {% endif %}
  </div>
</div>

<!-- MODAL CONFIRMACI√ìN -->
<div id="modalEstado" class="modal">
  <div class="modal-content">
    <h3 id="modalTitulo">Confirmar acci√≥n</h3>
    <p id="modalTexto">
      ¬øSeguro que deseas realizar esta acci√≥n?
    </p>
    <div class="modal-actions">
      <form id="modalForm" method="post" action="">
        {% csrf_token %}
        <button type="submit" id="modalBoton" class="btn">
          <i class="fas fa-check"></i> Confirmar
        </button>
      </form>
      <button type="button" class="btn btn-light" id="cerrarModalEstado">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL DESCARGA -->
<div id="modalDescarga" class="modal">
  <div class="modal-content">
    <h3>üìÇ Descarga completada</h3>
    <p id="textoDescarga">Procesando descarga...</p>
    <div class="modal-actions">
      <button type="button" class="btn btn-light" id="cerrarModalDescarga">Cerrar</button>
    </div>
  </div>
</div>

{# Modal visor de documentos #}
<div class="modal fade" id="visorCertificadoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content visor-modal">
      <div class="modal-header">
        <h5 class="modal-title">Certificado m√©dico</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body p-0">
        <div id="visor-loading" class="p-3">Cargando‚Ä¶</div>
        <iframe id="visor-frame" src="" style="display:none; border:0;"></iframe>
      </div>
      <div class="modal-footer justify-content-between">
        <div class="d-flex gap-2">
          <button id="visor-print" type="button" class="btn btn-outline-primary">Imprimir</button>
          <a id="visor-open-tab" href="#" target="_blank" class="btn btn-outline-secondary">Abrir en nueva pesta√±a</a>
        </div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL REGISTRAR PAGO -->
<div id="modalPago" class="modal">
  <div class="modal-content" style="max-width: 450px;">
    <h3>üí≥ Registrar Pago</h3>
    <form id="formRegistrarPago" method="post" action="{% url 'administracion:registrar_pago' 0 %}">
      {% csrf_token %}
      <p><strong>Estudiante:</strong> <span id="pagoEstudiante"></span></p>
      <p><strong>Cuota:</strong> <span id="pagoMes"></span> / <span id="pagoAnio"></span></p>
      <p><strong>Monto:</strong> $<span id="pagoMonto"></span></p>

      <label for="metodo_pago">M√©todo de pago:</label>
      <select name="metodo_pago" id="metodo_pago" required>
        <option value="">Seleccionar...</option>
        <option value="Efectivo">Efectivo</option>
        <option value="Transferencia">Transferencia</option>
        <option value="Tarjeta">Tarjeta</option>
        <option value="Otro">Otro</option>
      </select>

      <label for="observaciones">Observaciones (opcional):</label>
      <textarea name="observaciones" id="observaciones" rows="3"></textarea>

      <div class="modal-actions" style="margin-top: 1rem;">
        <button type="submit" class="btn btn-success">Confirmar</button>
        <button type="button" class="btn btn-light" id="cerrarModalPago">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL DESHACER PAGO -->
<div id="modalDeshacerPago" class="modal">
  <div class="modal-content" style="max-width: 420px;">
    <h3>‚ö†Ô∏è Deshacer Pago</h3>
    <p id="textoDeshacerPago">¬øSeguro que quer√©s deshacer este pago?</p>

    <form id="formDeshacerPago" method="post" action="{% url 'administracion:deshacer_pago' 0 %}">
      {% csrf_token %}
      <div class="modal-actions">
        <button type="submit" class="btn btn-danger">S√≠, deshacer pago</button>
        <button type="button" class="btn btn-light" id="cerrarModalDeshacerPago">Cancelar</button>
      </div>
    </form>
  </div>
</div>
<!-- MODAL ELIMINAR INSCRIPCI√ìN -->
<div id="modalEliminarInscripcion" class="modal">
  <div class="modal-content" style="max-width: 430px;">
    <h3>‚ö†Ô∏è Eliminar Inscripci√≥n</h3>
    <p id="textoEliminarInscripcion">¬øSeguro que deseas eliminar esta inscripci√≥n?</p>

    <form id="formEliminarInscripcion" method="post" action="">
      {% csrf_token %}
      <div class="modal-actions">
        <button type="submit" class="btn btn-danger">S√≠, eliminar</button>
        <button type="button" class="btn btn-light" id="cerrarModalEliminar">Cancelar</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block extra_js %}

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Pesta√±as
  const tabButtons = document.querySelectorAll(".tab-button");
  const tabContents = document.querySelectorAll(".tab-content");
  tabButtons.forEach(button => {
    button.addEventListener("click", () => {
      const tabId = button.getAttribute("data-tab");
      tabButtons.forEach(btn => btn.classList.remove("active"));
      tabContents.forEach(tab => tab.classList.remove("active"));
      button.classList.add("active");
      document.getElementById("tab-" + tabId).classList.add("active");
    });
  });

  // Modal
  const modal = document.getElementById("modalEstado");
  const abrir = document.getElementById("abrirModalEstado");
  const cerrar = document.getElementById("cerrarModalEstado");
  const modalTitulo = document.getElementById("modalTitulo");
  const modalTexto = document.getElementById("modalTexto");
  const modalBoton = document.getElementById("modalBoton");
  const modalForm = document.getElementById("modalForm");

  if (abrir && modal && cerrar) {
    abrir.addEventListener("click", () => {
      const accion = abrir.dataset.accion;
      const color = abrir.dataset.color;
      const nuevo = abrir.dataset.nuevo;

      modalTitulo.textContent = "Confirmar " + accion.charAt(0).toUpperCase() + accion.slice(1);
      modalTexto.innerHTML = `¬øSeguro que deseas <strong>${accion}</strong> la documentaci√≥n de <strong>{{ estudiante.apellidos_estudiante }}, {{ estudiante.nombres_estudiante }}</strong>?`;
      modalBoton.className = `btn btn-${color}`;
      modalBoton.innerHTML = `<i class="fas fa-check"></i> S√≠, ${accion}`;
      modalForm.action = `{% url 'cambiar_estado_documentacion' estudiante.id %}`;

      modal.style.display = "flex";
    });

    cerrar.addEventListener("click", () => modal.style.display = "none");
    window.addEventListener("click", e => {
      if (e.target === modal) modal.style.display = "none";
    });
  }
});

// üîπ Descarga de archivos con AJAX + modal
const btnDescargar = document.getElementById("btnDescargarArchivos");
const modalDescarga = document.getElementById("modalDescarga");
const textoDescarga = document.getElementById("textoDescarga");
const cerrarModalDescarga = document.getElementById("cerrarModalDescarga");

if (btnDescargar) {
  btnDescargar.addEventListener("click", async () => {
    textoDescarga.textContent = "Descargando archivos...";
    modalDescarga.style.display = "flex";

    try {
      const response = await fetch("{% url 'descargar_archivos_alumnos' %}", {
        method: "GET",
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });

      const data = await response.json();

      textoDescarga.innerHTML = `
        ${data.mensaje}<br>
        <small>${data.descargados.length} descargados</small>
        ${data.omitidos.length ? `<br><small>${data.omitidos.length} omitidos</small>` : ""}
      `;
    } catch (error) {
      textoDescarga.textContent = "‚ùå Error al descargar archivos.";
    }
  });
}

if (cerrarModalDescarga) {
  cerrarModalDescarga.addEventListener("click", () => modalDescarga.style.display = "none");
  window.addEventListener("click", e => { if (e.target === modalDescarga) modalDescarga.style.display = "none"; });
}

</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('btn-ver-certificado');
  if (!btn) return;

  const modalEl = document.getElementById('visorCertificadoModal');
  const iframe  = document.getElementById('visor-frame');
  const loading = document.getElementById('visor-loading');
  const openTab = document.getElementById('visor-open-tab');
  const closeBtn = modalEl.querySelector('[data-bs-dismiss="modal"]');

  // Detectar si hay Bootstrap
  const hasBootstrap = !!(window.bootstrap && typeof window.bootstrap.Modal === 'function');
  let bsInstance = null;

  function resetViewer() {
    iframe.style.display = 'none';
    loading.style.display = 'block';
    // liberar recurso anterior
    iframe.src = '';
  }

  function fillViewer(url) {
    openTab.href = url;
    iframe.onload = () => {
      loading.style.display = 'none';
      iframe.style.display = 'block';
    };
    iframe.src = url;
  }

  function openModal() {
    if (hasBootstrap) {
      if (!bsInstance) bsInstance = new bootstrap.Modal(modalEl);
      bsInstance.show();
    } else {
      modalEl.classList.add('show');
      modalEl.style.display = 'block';
      modalEl.removeAttribute('aria-hidden');
      // evitar scroll de fondo
      document.body.classList.add('modal-open');
    }
  }

  function closeModal() {
    // limpiar iframe SIEMPRE
    iframe.src = '';

    if (hasBootstrap && bsInstance) {
      bsInstance.hide();
    } else {
      modalEl.classList.remove('show');
      modalEl.style.display = 'none';
      modalEl.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('modal-open');
    }
  }

  // Click del bot√≥n principal
  btn.addEventListener('click', () => {
    const url = btn.getAttribute('data-view-url');
    if (!url) return;
    resetViewer();
    fillViewer(url);
    openModal();
  });

  // Cerrar con bot√≥n X (sin {once:true})
  if (closeBtn) {
    closeBtn.addEventListener('click', (e) => {
      e.preventDefault();
      closeModal();
    });
  }

  // Cerrar clickeando fuera del di√°logo (fallback)
  modalEl.addEventListener('click', (e) => {
    if (hasBootstrap) return; // Bootstrap ya lo maneja
    // Clic en backdrop: el target es el contenedor .modal (no .modal-dialog)
    if (e.target === modalEl) closeModal();
  });

  // Cerrar con ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      // Solo si el modal est√° visible
      const visible = modalEl.classList.contains('show') || modalEl.style.display === 'block';
      if (visible) closeModal();
    }
  });
});


</script>
<script>

document.getElementById('visor-print')?.addEventListener('click', () => {
  const iframe = document.getElementById('visor-frame');
  const openTab = document.getElementById('visor-open-tab');
  try {
    iframe.contentWindow.focus();
    iframe.contentWindow.print();
  } catch (e) {
    if (openTab && openTab.href) window.open(openTab.href, '_blank');
  }
});</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const modalPago = document.getElementById("modalPago");
  const formPago = document.getElementById("formRegistrarPago");
  const cerrarModalPago = document.getElementById("cerrarModalPago");

  // Campos din√°micos
  const pagoEstudiante = document.getElementById("pagoEstudiante");
  const pagoMes = document.getElementById("pagoMes");
  const pagoAnio = document.getElementById("pagoAnio");
  const pagoMonto = document.getElementById("pagoMonto");

  // Abrir modal
  document.querySelectorAll(".btn-registrar-pago").forEach(btn => {
    btn.addEventListener("click", () => {
      const cuotaId = btn.dataset.cuotaId;
      const monto = btn.dataset.monto;
      const mes = btn.dataset.mes;
      const anio = btn.dataset.anio;
      const estudiante = btn.dataset.estudiante;

      pagoEstudiante.textContent = estudiante;
      pagoMes.textContent = mes;
      pagoAnio.textContent = anio;
      pagoMonto.textContent = monto;

      // Actualizamos la URL del form din√°micamente
      const url = "{% url 'administracion:registrar_pago' 0 %}".replace("0", cuotaId);
      formPago.action = url;

      modalPago.style.display = "flex";
    });
  });

  // Cerrar modal
  if (cerrarModalPago) {
    cerrarModalPago.addEventListener("click", () => modalPago.style.display = "none");
    window.addEventListener("click", e => { if (e.target === modalPago) modalPago.style.display = "none"; });
  }
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const modalDeshacer = document.getElementById("modalDeshacerPago");
  const formDeshacer = document.getElementById("formDeshacerPago");
  const cerrarModalDeshacer = document.getElementById("cerrarModalDeshacerPago");
  const textoDeshacer = document.getElementById("textoDeshacerPago");

  document.querySelectorAll(".btn-deshacer-pago").forEach(btn => {
    btn.addEventListener("click", () => {
      const cuotaId = btn.dataset.cuotaId;
      const estudiante = btn.dataset.estudiante;
      textoDeshacer.innerHTML = `¬øSeguro que quer√©s <strong>deshacer el pago</strong> de <strong>${estudiante}</strong>?`;

      // Actualiza la URL din√°mica
      const url = "{% url 'administracion:deshacer_pago' 0 %}".replace("0", cuotaId);
      formDeshacer.action = url;

      modalDeshacer.style.display = "flex";
    });
  });

  // Cerrar modal
  if (cerrarModalDeshacer) {
    cerrarModalDeshacer.addEventListener("click", () => modalDeshacer.style.display = "none");
    window.addEventListener("click", e => { if (e.target === modalDeshacer) modalDeshacer.style.display = "none"; });
  }
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const modalEliminar = document.getElementById("modalEliminarInscripcion");
  const formEliminar = document.getElementById("formEliminarInscripcion");
  const textoEliminar = document.getElementById("textoEliminarInscripcion");
  const btnAbrirEliminar = document.getElementById("abrirModalEliminar");
  const btnCerrarEliminar = document.getElementById("cerrarModalEliminar");

  if (btnAbrirEliminar) {
    btnAbrirEliminar.addEventListener("click", () => {
      const inscripcionId = btnAbrirEliminar.dataset.inscripcionId;
      const estudiante = btnAbrirEliminar.dataset.estudiante;

      textoEliminar.innerHTML = `¬øSeguro que quer√©s <strong>eliminar la inscripci√≥n</strong> de <strong>${estudiante}</strong>?<br><small>Se eliminar√°n tambi√©n todas las cuotas asociadas.</small>`;
      
      const url = "{% url 'administracion:eliminar_inscripcion' 0 %}".replace("0", inscripcionId);
      formEliminar.action = url;

      modalEliminar.style.display = "flex";
    });
  }

  if (btnCerrarEliminar) {
    btnCerrarEliminar.addEventListener("click", () => modalEliminar.style.display = "none");
    window.addEventListener("click", e => {
      if (e.target === modalEliminar) modalEliminar.style.display = "none";
    });
  }
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const toasts = document.querySelectorAll(".toast-message");
  toasts.forEach((toast, index) => {
    // Peque√±o retraso si hay varios
    const delay = index * 200;
    setTimeout(() => {
      toast.style.opacity = "1";
      // Desvanecer despu√©s de 4s
      setTimeout(() => {
        toast.style.animation = "fadeOut 0.4s ease forwards";
        setTimeout(() => toast.remove(), 400);
      }, 4000);
    }, delay);
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const todas = document.getElementById('todas');
  const desde = document.getElementById('desde');
  const hasta = document.getElementById('hasta');

  todas.addEventListener('change', () => {
    const disabled = todas.checked;
    desde.disabled = disabled;
    hasta.disabled = disabled;
  });
});
</script>

{% endblock %}
