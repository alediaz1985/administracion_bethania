{% extends 'base.html' %}
{% load static %}

{% block title %}Editar Perfil{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'autenticacion/css/styles_editar_perfil.css' %}">
{% endblock %}

{% block content %}
<div class="perfil-editar-card">

  <form method="post" enctype="multipart/form-data" class="perfil-editar-form">
    {% csrf_token %}

    <!-- NUEVO: resumen de errores de ambos forms -->
    {% if user_form.errors or perfil_form.errors %}
      <div class="alert alert-danger" style="margin-bottom:1rem">
        {{ user_form.non_field_errors }}
        {{ perfil_form.non_field_errors }}

        {% for field in user_form %}
          {% for err in field.errors %}
            <div><strong>{{ field.label }}:</strong> {{ err }}</div>
          {% endfor %}
        {% endfor %}

        {% for field in perfil_form %}
          {% for err in field.errors %}
            <div><strong>{{ field.label }}:</strong> {{ err }}</div>
          {% endfor %}
        {% endfor %}
      </div>
    {% endif %}
    <!-- /NUEVO -->

    <div class="perfil-editar-header">
      <!-- FOTO -->
      <div class="perfil-editar-foto">
        <label for="id_foto" class="foto-label" style="cursor:pointer">
          <img id="previewFoto"
               src="{{ request.user.perfil.foto_url }}?v={{ request.user.last_login|date:'U' }}"
               alt="Foto de perfil"
               class="perfil-photo">
        </label>

        {# si usás input manual, dejalo: #}
        <input type="file" name="foto" id="id_foto" accept="image/*" style="display:none">

        <!-- NUEVO: error del campo foto -->
        {% if perfil_form.foto.errors %}
          <div class="text-danger" style="margin-top:.5rem">
            {{ perfil_form.foto.errors.0 }}
          </div>
        {% endif %}
        <!-- /NUEVO -->

        <p class="foto-texto">Haz clic en la imagen para cambiarla</p>
      </div>

      <!-- CAMPOS A LA DERECHA -->
      <div class="perfil-editar-campos">
        <div class="perfil-row">
          <div class="campo">
            <label for="id_first_name">Nombre</label>
            {{ user_form.first_name }}
          </div>
          <div class="campo">
            <label for="id_last_name">Apellido</label>
            {{ user_form.last_name }}
          </div>
        </div>

        <div class="perfil-row">
          <div class="campo campo-full">
            <label for="id_email">Correo electrónico</label>
            {{ user_form.email }}
          </div>
        </div>

        <div class="perfil-row">
          <div class="campo">
            <label for="password">Nueva contraseña</label>
            <input type="password" name="password" placeholder="••••">
          </div>
          <div class="campo">
            <label for="password_confirm">Confirmar contraseña</label>
            <input type="password" name="password_confirm" placeholder="••••">
          </div>
        </div>

        <div class="perfil-actions">
          <button type="submit" class="btn">Guardar</button>
          <a href="{% url 'ver_perfil' %}" class="btn btn-light">Volver</a>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- PREVIEW FOTO -->
<script>
document.getElementById("id_foto").addEventListener("change", function (event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = e => document.getElementById("previewFoto").src = e.target.result;
    reader.readAsDataURL(file);
  }
});
</script>
{% endblock %}
