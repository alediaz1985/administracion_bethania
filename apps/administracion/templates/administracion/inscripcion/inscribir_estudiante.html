{% extends 'base.html' %}
{% load static %}

{% block title %}Inscripci√≥n Administrativa{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'administracion/css/inscribir/styles_inscripcion_adm.css' %}">
{% endblock %}

{% block content %}
<div class="student-card">

  <!-- üîπ Cabecera -->
  <div class="inscripcion-header">
    <h2>Inscripci√≥n Administrativa</h2>
    <p class="subtitle">Verificaci√≥n de datos del estudiante antes de registrar la inscripci√≥n.</p>
  </div>

  <!-- üîî Mensajes del sistema -->
  {% if messages %}
    <div class="mensajes-sistema">
      {% for message in messages %}
        <div class="mensaje {{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- üßç Datos del Estudiante -->
  <div class="datos-estudiante">
    <h3>Datos del Estudiante</h3>
    <div class="grid-datos">
      <div class="campo">
        <span class="label">Apellidos:</span>
        <span class="valor">{{ estudiante.apellidos_estudiante }}</span>
      </div>
      <div class="campo">
        <span class="label">Nivel:</span>
        {% if estudiante.inscripcion %}
          <span class="valor">{{ estudiante.inscripcion.nivel_estudiante }}</span>
        {% else %}
          <span class="valor">‚Äî</span>
        {% endif %}
      </div>

      <div class="campo">
        <span class="label">Nombres:</span>
        <span class="valor">{{ estudiante.nombres_estudiante }}</span>
      </div>
      <div class="campo">
        <span class="label">Curso / A√±o:</span>
        {% if estudiante.inscripcion %}
          <span class="valor">{{ estudiante.inscripcion.curso_anio_estudiante }}</span>
        {% else %}
          <span class="valor">‚Äî</span>
        {% endif %}
      </div>

      <div class="campo">
        <span class="label">CUIL:</span>
        <span class="valor">{{ estudiante.cuil_estudiante }}</span>
      </div>
      <div class="campo">
        <span class="label">Turno:</span>
        {% if estudiante.inscripcion %}
          <span class="valor">{{ estudiante.inscripcion.turno_estudiante }}</span>
        {% else %}
          <span class="valor">‚Äî</span>
        {% endif %}
      </div>
    </div>

    {% if not estudiante.inscripcion %}
    <p class="no-inscripcion">
      ‚ö†Ô∏è Este estudiante a√∫n no posee datos acad√©micos registrados.
    </p>
    {% endif %}
  </div>

  <!-- üßæ Estado de documentaci√≥n -->
  <div class="estado-doc">
    {% if estado_doc %}
      {% if estado_doc.estado|lower == 'aprobado' %}
        <p class="estado-aprobado">‚úÖ Documentaci√≥n aprobada ‚Äî El estudiante puede ser inscripto.</p>
      {% else %}
        <p class="estado-pendiente">‚ö†Ô∏è Documentaci√≥n pendiente ‚Äî No puede inscribirse a√∫n.</p>
      {% endif %}
    {% else %}
      <p class="estado-pendiente">‚ö†Ô∏è No se encontr√≥ informaci√≥n de documentaci√≥n.</p>
    {% endif %}
  </div>

  <!-- üìã Formulario de Inscripci√≥n -->
  {% if puede_inscribir %}
  <div class="registro-container">
    <div class="form-inscripcion">
      <h3>Registrar Inscripci√≥n</h3>
      <form method="post">
        {% csrf_token %}

        <table class="tabla-datos">
          <tr>
            <th>Ciclo Lectivo:</th>
            <td>
              <select name="ciclo" required>
                <option value="">Seleccione...</option>
                {% for ciclo in ciclos %}
                  <option value="{{ ciclo.id }}">{{ ciclo.anio }}</option>
                {% endfor %}
              </select>
            </td>
          </tr>
          <tr>
            <th>Nivel:</th>
            <td>
              <select name="nivel" required>
                <option value="">Seleccione...</option>
                {% for nivel in niveles %}
                  <option value="{{ nivel.id }}">{{ nivel.nombre }}</option>
                {% endfor %}
              </select>
            </td>
          </tr>
          <tr>
            <th>Subnivel:</th>
            <td>
              <select name="subnivel" required>
                <option value="">Seleccione...</option>
                {% for subnivel in subniveles %}
                  <option value="{{ subnivel.id }}">{{ subnivel.nombre }}</option>
                {% endfor %}
              </select>
            </td>
          </tr>
          <tr>
            <th>Turno:</th>
            <td>
              <select name="turno" required>
                <option value="">Seleccione...</option>
                <option value="Ma√±ana">Ma√±ana</option>
                <option value="Tarde">Tarde</option>
              </select>
            </td>
          </tr>
          <tr>
            <th>Beca (opcional):</th>
            <td>
              <select name="beca">
                <option value="">Sin beca</option>
                {% for beca in becas %}
                  <option value="{{ beca.id }}">{{ beca.nombre }} - {{ beca.tipo }} {{ beca.valor }}</option>
                {% endfor %}
              </select>
            </td>
          </tr>
          <tr>
            <th>Observaciones:</th>
            <td><textarea name="observaciones" rows="3"></textarea></td>
          </tr>
        </table>

        <div class="student-actions">
          <button type="submit" class="btn-inscribir">Inscribir</button>
        </div>
      </form>
    </div>
    <!-- üí∞ Columna Derecha: Montos din√°micos -->
    <div class="montos-container">
      <h3>Montos del Nivel Seleccionado</h3>
      <div class="montos-info">
        <p><strong>Inscripci√≥n:</strong> <span id="monto-inscripcion">‚Äî</span></p>
        <p><strong>Cuota mensual:</strong> <span id="monto-cuota">‚Äî</span></p>
        <p><strong>Beca aplicada:</strong> <span id="monto-beca">‚Äî</span></p>
        <p class="total"><strong>Total final:</strong> <span id="monto-total">‚Äî</span></p>
      </div>
    </div>
  </div>  
  {% endif %}

  <!-- üîò Volver -->
  <div class="student-actions">
    <a href="{% url 'ver_datos_estudiante' estudiante.id %}" class="btn-light">Volver</a>
  </div>

</div>

{{ montos_json|json_script:"montos-json" }}

<script>
document.addEventListener('DOMContentLoaded', function () {
  // 1) Cargar JSON de forma segura
  var montosScript = document.getElementById('montos-json');
  var montosData = [];
  if (montosScript && montosScript.textContent) {
    try {
      montosData = JSON.parse(montosScript.textContent);
    } catch (e) {
      montosData = [];
    }
  }

  // 2) Tomar referencias de elementos
  var nivelSelect = document.querySelector('select[name="nivel"]');
  var cicloSelect = document.querySelector('select[name="ciclo"]');
  var becaSelect  = document.querySelector('select[name="beca"]');

  var spanInscripcion = document.getElementById('monto-inscripcion');
  var spanCuota       = document.getElementById('monto-cuota');
  var spanBeca        = document.getElementById('monto-beca');
  var spanTotal       = document.getElementById('monto-total');

  // Si faltan elementos clave, no seguimos
  if (!nivelSelect || !cicloSelect || !spanInscripcion || !spanCuota || !spanBeca || !spanTotal) {
    return;
  }

  var cuotaBase = 0;

  function formatear(valor) {
    try {
      return '$' + Number(valor).toLocaleString('es-AR', { minimumFractionDigits: 2 });
    } catch (e) {
      var n = Math.round(Number(valor) * 100) / 100;
      return '$' + n;
    }
  }

  function limpiarMontos() {
    spanInscripcion.textContent = '‚Äî';
    spanCuota.textContent       = '‚Äî';
    spanBeca.textContent        = '‚Äî';
    spanTotal.textContent       = '‚Äî';
  }

  function actualizarMontos() {
    var cicloId = parseInt(cicloSelect.value || '0', 10);
    var nivelId = parseInt(nivelSelect.value || '0', 10);

    // Buscar registro en montosData
    var monto = null;
    for (var i = 0; i < montosData.length; i++) {
      var m = montosData[i];
      if (m.nivel_id === nivelId && m.ciclo_id === cicloId) {
        monto = m;
        break;
      }
    }

    if (!monto) {
      limpiarMontos();
      return;
    }

    cuotaBase = Number(monto.monto_cuota) || 0;
    spanInscripcion.textContent = formatear(monto.monto_inscripcion);
    spanCuota.textContent       = formatear(cuotaBase);

    // Beca
    var becaTexto = '';
    if (becaSelect && becaSelect.options && becaSelect.selectedIndex >= 0) {
      becaTexto = becaSelect.options[becaSelect.selectedIndex].textContent || '';
    }

    // Reset beca
    spanBeca.textContent  = '‚Äî';
    spanTotal.textContent = formatear(cuotaBase);

    if (becaTexto.indexOf('Porcentaje') !== -1) {
      var pctStr = becaTexto.replace(/[^0-9.,]/g, '').replace(',', '.');
      var porcentaje = parseFloat(pctStr);
      if (!isNaN(porcentaje)) {
        var descuento = cuotaBase * (porcentaje / 100);
        var total     = Math.max(cuotaBase - descuento, 0);
        spanBeca.textContent  = '-' + formatear(descuento);
        spanTotal.textContent = formatear(total);
      }
    } else if (becaTexto.indexOf('Monto fijo') !== -1) {
      var fijoStr = becaTexto.replace(/[^0-9.,]/g, '').replace(',', '.');
      var fijo = parseFloat(fijoStr);
      if (!isNaN(fijo)) {
        var total2 = Math.max(cuotaBase - fijo, 0);
        spanBeca.textContent  = '-' + formatear(fijo);
        spanTotal.textContent = formatear(total2);
      }
    }
  }

  // 3) Listeners (solo si existen)
  if (nivelSelect) nivelSelect.addEventListener('change', actualizarMontos);
  if (cicloSelect) cicloSelect.addEventListener('change', actualizarMontos);
  if (becaSelect)  becaSelect.addEventListener('change', actualizarMontos);

  // 4) Calcular al cargar, por si hay valores preseleccionados
  actualizarMontos();
});
</script>


{% endblock %}
