{% extends 'base.html' %}

{% block title %}Consulta de Comprobantes de Pago{% endblock %}

{% load static %}

{% get_media_prefix as MEDIA_URL %}

{% block extra_styles %}
    <link rel="stylesheet" href="{% static 'cuotas/css/consulta_comprobante_nuevo.css' %}">
{% endblock %}

{% block content %}
<article class="consulta">
    <div class="consulta__contenedor">
        <!-- SecciÃ³n: Buscador -->
        <section class="consulta__buscador">
            <h2 class="consulta__titulo">Buscar Comprobantes de Pago</h2>

            <form class="buscador__formulario" method="GET" action="{% url 'cuotas:buscar_comprobantes' %}">
                {% csrf_token %}

                <div class="formulario__grupo">
                    <label class="formulario__etiqueta" for="cuil_alumno">CUIL Alumno:</label>
                    <input class="formulario__input" type="text" name="cuil_alumno" id="cuil_alumno"
                        placeholder="Ingresar CUIL del alumno" value="{{ request.GET.cuil_alumno }}">
                </div>

                <div class="formulario__grupo">
                    <label class="formulario__etiqueta" for="fecha_desde">Fecha Desde:</label>
                    <input class="formulario__campo" type="date" name="fecha_desde" id="fecha_desde"
                        value="{{ request.GET.fecha_desde }}">

                    <label class="formulario__etiqueta" for="fecha_hasta">Fecha Hasta:</label>
                    <input class="formulario__campo" type="date" name="fecha_hasta" id="fecha_hasta"
                        value="{{ request.GET.fecha_hasta }}">
                </div>

                <button class="boton-accion" type="submit">
                    <span class="boton-accion__circulo" aria-hidden="true">
                        <span class="boton-accion__icono boton-accion__icono--flecha"></span>
                    </span>
                    <span class="boton-accion__texto">Buscar</span>
                </button>
            </form>
        </section>

        <!-- SecciÃ³n: Resultados -->
        <section class="consulta__resultados">
            <h3 class="consulta__subtitulo">Resultados de la bÃºsqueda</h3>
            <!-- BotÃ³n siempre visible -->
            <form id="form-actualizar" method="POST" action="{% url 'cuotas:buscar_comprobantes' %}">
                {% csrf_token %}
                <button type="submit" name="descargar_todos" value="1">Actualizar Datos</button>
            </form>

            {% if request.GET.cuil_alumno or request.GET.fecha_desde or request.GET.fecha_hasta %}
            {% if comprobantes %}
            <table class="tabla">
                <thead class="tabla__encabezado">
                    <tr class="tabla__fila">
                        <th class="tabla__columna">CUIL Alumno</th>
                        <th class="tabla__columna">CUIL Responsable</th>
                        <th class="tabla__columna">Email</th>
                        <th class="tabla__columna">Fecha de EnvÃ­o</th>
                        <th class="tabla__columna"></th>
                        <th class="tabla__columna"></th>
                    </tr>
                </thead>
                <tbody class="tabla__cuerpo">
                    {% for comprobante in comprobantes %}
                        <tr class="tabla__fila">
                            <td class="tabla__celda">{{ comprobante.cuil_alumno }}</td>
                            <td class="tabla__celda">{{ comprobante.cuil_responsable }}</td>
                            <td class="tabla__celda">{{ comprobante.email }}</td>
                            <td class="tabla__celda">{{ comprobante.marca_temporal }}</td>
                            <td class="tabla__celda">
                                {% if comprobante.ruta_local %}
                                    {% with comprobante.ruta_local|lower as ruta %}
                                        {% if ruta|slice:"-4:" == ".pdf" %}
                                            <a href="/media/{{ comprobante.ruta_local }}" target="_blank">
                                                <button class="boton boton--ver" type="button">Ver Comprobante</button>
                                            </a>
                                        {% elif ruta|slice:"-4:" == ".jpg" or ruta|slice:"-5:" == ".jpeg" or ruta|slice:"-4:" == ".png" or ruta|slice:"-4:" == ".gif" %}
                                            <a href="/media/{{ comprobante.ruta_local }}" target="_blank">
                                                <button class="boton boton--ver" type="button">Ver Imagen</button>
                                            </a>
                                        {% else %}
                                            <span>Archivo no compatible</span>
                                        {% endif %}
                                    {% endwith %}
                                {% endif %}
                            </td>                                      
                            <td class="tabla__celda">
                                <a href="{% url 'cuotas:buscar_cuotas_estudiante' %}?cuil={{ comprobante.cuil_alumno }}">
                                    <button class="boton boton--registro" type="button">Registro del Pago</button>
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
                <p class="consulta__mensaje">No se encontraron resultados.</p>
            {% endif %}
            {% endif %}
        </section>
    </div>
</article>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const formActualizar = document.getElementById("form-actualizar");

    if (formActualizar) {
        formActualizar.addEventListener("submit", function () {
            const overlay = document.createElement("div");
            overlay.classList.add("pantalla-cargando");
            overlay.innerHTML = `
                <div class="pantalla-cargando__contenido">
                    ðŸ”„ Actualizando datos, por favor espere...
                    <span class="reloj-areana"><i class="fas fa-hourglass"></i></span>
                </div>
            `;
            document.body.appendChild(overlay);
        });
    }
});
</script>
{% endblock %}
