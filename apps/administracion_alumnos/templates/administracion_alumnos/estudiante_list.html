{% extends 'base.html' %}
{% load static %}

{% block title %}Lista de Estudiantes{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'administracion_alumnos/css/styles_listar_alumnos.css' %}">
{% endblock %}

{% block content %}

<!-- üß© CONTENEDOR PRINCIPAL -->
<div class="alumnos-container">

    <!-- üîπ ENCABEZADO: Filtros y acciones -->
    <div class="alumnos">

      <!-- üî∏ Filtros (Nivel + Subnivel) -->
      <div class="filters">
        <select id="nivel-filter" name="nivel">
          <option value="">Seleccionar Nivel</option>
          <option value="Inicial">Nivel Inicial</option>
          <option value="Primario">Nivel Primario</option>
          <option value="Secundario">Nivel Secundario</option>
        </select>

        <select id="subnivel-filter" name="subnivel">
          <option value="">Seleccionar Subnivel</option>
          <option value="Sala de 3 a√±os">Sala de 3 a√±os</option>
          <option value="Sala de 4 a√±os">Sala de 4 a√±os</option>
          <option value="Sala de 5 a√±os">Sala de 5 a√±os</option>
          <option value="1er Grado">1er Grado</option>
          <option value="2do Grado">2do Grado</option>
          <option value="3er Grado">3er Grado</option>
          <option value="4to Grado">4to Grado</option>
          <option value="5to Grado">5to Grado</option>
          <option value="6to Grado">6to Grado</option>
          <option value="7mo Grado">7mo Grado</option>
          <option value="1er A√±o">1er A√±o</option>
          <option value="2do A√±o">2do A√±o</option>
          <option value="3er A√±o">3er A√±o</option>
          <option value="4to A√±o">4to A√±o</option>
          <option value="5to A√±o">5to A√±o</option>
        </select>
      </div>

      <!-- üî∏ Buscador centrado -->
      <div class="search-box">
        <input type="text" id="search-input" placeholder="Buscar por CUIL o Nombre..." />
      </div>

      <!-- üî∏ Acciones (Botones PDF y Refrescar) -->
      <div class="actions">
        <a href="{% url 'registrar_alumno' %}" class="btn-minimal" title="Registrar nuevo estudiante">
          <i class="fas fa-user-plus"></i>
          <span>Registrar</span>
        </a>

        <form action="{% url 'generar_pdf_lista_alumnos' %}" method="get">
          <button type="submit" class="btn-minimal" title="Generar PDF">
            <i class="fas fa-file-pdf"></i>
            <span>Generar PDF</span>
          </button>
        </form>

        <button type="button" id="btn-refresh" class="btn-minimal" title="Actualizar datos" onclick="refrescarDatos()">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>
    </div>

    <!-- üîπ Contenedor con scroll para las tablas -->
    <div class="alumnos-scroll-container">
      <table class="alumnos-table" id="data-table">
          <thead>
              <tr>
                  <th>CUIL</th>
                  <th>Apellido/s</th>
                  <th>Nombre/s</th>
                  <th>Nivel</th>
                  <th>Subnivel</th>
                  <th>Turno</th>
                  <th>Fecha Recepci√≥n</th>
                  <th>Estado</th>
                  <th colspan="2"></th>
              </tr>
          </thead>
          <tbody class="table-body">
              {% if estudiantes %}
                  {% for estudiante in estudiantes %}
                      <tr data-nivel="{{ estudiante.inscripcion.nivel_estudiante }}"
                          data-subnivel="{{ estudiante.inscripcion.curso_anio_estudiante }}"
                          data-turno="{{ estudiante.inscripcion.turno_estudiante }}">
                          
                          <!-- CUIL + Bot√≥n copiar -->
                          <td>
                              <span id="cuil_{{ estudiante.id }}">{{ estudiante.cuil_estudiante }}</span>
                              <button onclick="copiarTexto('cuil_{{ estudiante.id }}')" style="border: none; background: transparent; cursor: pointer;">
                                  <i class="fas fa-copy" style="color: #b6b6b6;"></i>
                              </button>
                          </td>

                          <!-- Datos principales -->
                          <td>{{ estudiante.apellidos_estudiante }}</td>
                          <td>{{ estudiante.nombres_estudiante }}</td>
                          <td>{{ estudiante.inscripcion.nivel_estudiante }}</td>
                          <td>{{ estudiante.inscripcion.curso_anio_estudiante }}</td>
                          <td>{{ estudiante.inscripcion.turno_estudiante }}</td>
                          <td>{{ estudiante.inscripcion.fecha_recepcion }}</td>

                          <!-- üîπ Estado de inscripci√≥n -->
                          <td>
                            <span class="badge bg-{{ estudiante.estado_color }}">
                              {{ estudiante.estado_inscripcion }}
                            </span>
                          </td>

                          <!-- Acciones -->
                          <td class="acciones">
                              <form action="{% url 'ver_datos_estudiante' pk=estudiante.pk %}" method="get" class="icon-form">
                                  <button class="icon-btn" title="Ver datos" type="submit">
                                      <i class="fas fa-search"></i>
                                  </button>
                              </form>
                              <form action="{% url 'generar_contrato' estudiante.pk %}" method="get" class="icon-form">
                                  <button class="icon-btn pdf" title="Generar contrato PDF" type="submit">
                                      <i class="fas fa-file-pdf"></i>
                                  </button>
                              </form>
                              <!-- Editar -->
                              <a href="{% url 'estudiante_edit' pk=estudiante.pk %}" class="icon-btn edit" title="Editar datos">
                                  <i class="fas fa-edit"></i>
                              </a>

                              <!-- Eliminar -->
                              <a href="{% url 'estudiante_delete' pk=estudiante.pk %}" class="icon-btn delete" title="Eliminar registro">
                                  <i class="fas fa-trash-alt"></i>
                              </a>
                          </td>
                      </tr>
                  {% endfor %}
              {% else %}
                  <tr><td colspan="9">No hay alumnos en la base de datos.</td></tr>
              {% endif %}
          </tbody>
      </table>

    <!-- üîî Toast minimalista superior -->
    <div id="toast-general"
        style="
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: #111;
            color: #f9f9f9;
            font-size: 13px;
            padding: 8px 14px;
            border-radius: 4px;
            opacity: 0;
            display: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 9999;
            letter-spacing: 0.2px;
        ">
    </div>

    <!-- üî∏ MODAL CONFIRMACI√ìN ELIMINAR -->
    <div id="modal-delete" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3>¬øEliminar registro?</h3>
        <p>¬øEst√°s seguro de que quer√©s eliminar este estudiante? Esta acci√≥n no se puede deshacer.</p>
        <div class="modal-actions">
        <button id="confirm-delete" class="btn-danger">Eliminar</button>
        <button id="cancel-delete" class="btn-secondary">Cancelar</button>
        </div>
    </div>
    </div>
</div>

<!-- =====================================================
üìú SCRIPTS FUNCIONALES
===================================================== -->
<script>

/* --------------------------------------------------
   üîπ Formatear fechas (es-AR)
-------------------------------------------------- */
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.fecha').forEach(el => {
    const val = el.textContent.trim();
    const d = new Date(val);
    el.textContent = !isNaN(d) ? d.toLocaleDateString('es-AR') : '';
  });
});

/* --------------------------------------------------
   üîπ Filtro por nivel (solo pesta√±a activa)
-------------------------------------------------- */
document.addEventListener('DOMContentLoaded', () => {
  const nivelFilter = document.getElementById('nivel-filter');
  const subnivelFilter = document.getElementById('subnivel-filter');
  const filas = document.querySelectorAll('#data-table tbody.table-body tr');

  function filterTable() {
    const nivel = (nivelFilter.value || '').toLowerCase();
    const subnivel = (subnivelFilter.value || '').toLowerCase();

    filas.forEach(row => {
      const rowNivel = (row.getAttribute('data-nivel') || '').toLowerCase();
      const rowSubnivel = (row.getAttribute('data-subnivel') || '').toLowerCase();

      const coincideNivel = nivel === "" || rowNivel.includes(nivel);
      const coincideSubnivel = subnivel === "" || rowSubnivel.includes(subnivel);

      // üîπ Mostrar solo si cumple ambos filtros
      row.style.display = (coincideNivel && coincideSubnivel) ? "" : "none";
    });
  }

  nivelFilter.addEventListener('change', filterTable);
  subnivelFilter.addEventListener('change', filterTable);
  window.__filterTable = filterTable;
  filterTable();
});

/* --------------------------------------------------
   üîπ Toast minimalista superior
-------------------------------------------------- */
function showToast(message, type = 'info') {
  const toast = document.getElementById('toast-general');
  if (!toast) return;

  const color = {
    info: '#111',
    ok: '#0b874b',
    error: '#b61c1c'
  }[type] || '#111';

  toast.textContent = message;
  toast.style.background = color;
  toast.style.display = 'block';
  toast.style.transform = 'translateX(-50%) translateY(0)';
  requestAnimationFrame(() => (toast.style.opacity = '1'));

  clearTimeout(toast.__t);
  toast.__t = setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => (toast.style.display = 'none'), 300);
  }, 1800);
}

/* --------------------------------------------------
   üîπ Copiar CUIL
-------------------------------------------------- */
function copiarTexto(elementId) {
  const el = document.getElementById(elementId);
  if (!el) return;

  const txt = el.textContent.trim();
  navigator.clipboard.writeText(txt).then(() => {
    showToast('CUIL copiado', 'ok');
  }).catch(() => {
    showToast('Error al copiar', 'error');
  });
}

/* --------------------------------------------------
   üîπ Refrescar datos (con feedback visual)
-------------------------------------------------- */
function refrescarDatos() {
  const btn = document.getElementById('btn-refresh');
  if (!btn) return;

  btn.disabled = true;
  btn.classList.add('loading');
  showToast('Actualizando datos‚Ä¶', 'info');

  fetch(window.location.href, { cache: "no-store" })
    .then(r => r.text())
    .then(html => {
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const newTable = doc.querySelector('.alumnos-scroll-container');
      const container = document.querySelector('.alumnos-scroll-container');

      if (newTable && container) {
        container.innerHTML = newTable.innerHTML;
        if (window.__filterTable) window.__filterTable();
        showToast('Datos actualizados', 'ok');
      } else {
        showToast('No se pudo actualizar', 'error');
      }
    })
    .catch(err => {
      console.error(err);
      showToast('Error al actualizar', 'error');
    })
    .finally(() => {
      btn.classList.remove('loading');
      btn.disabled = false;
    });
}

/* --------------------------------------------------
   üîπ Buscador por CUIL o Nombre (todas las pesta√±as)
   ‚Äî Ignora tildes, may√∫sculas y min√∫sculas
-------------------------------------------------- */
document.addEventListener('DOMContentLoaded', () => {
  const searchInput = document.getElementById('search-input');
  if (!searchInput) return;

  const filas = document.querySelectorAll('#data-table tbody.table-body tr');

  function limpiarTexto(texto) {
    return texto
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "");
  }

  searchInput.addEventListener('input', () => {
    const query = limpiarTexto(searchInput.value.trim());
    filas.forEach(row => {
      const cuil = limpiarTexto(row.cells[0]?.textContent || "");
      const apellido = limpiarTexto(row.cells[1]?.textContent || "");
      const nombre = limpiarTexto(row.cells[2]?.textContent || "");
      const visible =
        cuil.includes(query) || apellido.includes(query) || nombre.includes(query);
      row.style.display = visible ? "" : "none";
    });
  });
});

/* --------------------------------------------------
   üîπ Confirmar eliminaci√≥n con modal
-------------------------------------------------- */
document.addEventListener('DOMContentLoaded', () => {
  const modal = document.getElementById('modal-delete');
  const confirmBtn = document.getElementById('confirm-delete');
  const cancelBtn = document.getElementById('cancel-delete');
  let currentDeleteUrl = null;
  let currentRow = null;

  // Detectar clic en los √≠conos de eliminar
  document.querySelectorAll('.icon-btn.delete').forEach(btn => {
    btn.addEventListener('click', e => {
      e.preventDefault();
      currentDeleteUrl = btn.getAttribute('href');
      currentRow = btn.closest('tr');
      modal.style.display = 'flex';
    });
  });

  // Confirmar eliminaci√≥n
  confirmBtn.addEventListener('click', () => {
    if (!currentDeleteUrl) return;

    fetch(currentDeleteUrl, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCSRFToken() },
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        currentRow.remove();
        showToast('Registro eliminado', 'ok');
      } else {
        showToast('Error al eliminar', 'error');
      }
    })
    .catch(() => showToast('Error al eliminar', 'error'))
    .finally(() => {
      modal.style.display = 'none';
      currentDeleteUrl = null;
    });
  });

  // Cancelar eliminaci√≥n
  cancelBtn.addEventListener('click', () => {
    modal.style.display = 'none';
    currentDeleteUrl = null;
  });

  // Funci√≥n auxiliar para CSRF
  function getCSRFToken() {
    const name = 'csrftoken';
    const cookies = document.cookie.split(';');
    for (let c of cookies) {
      c = c.trim();
      if (c.startsWith(name + '=')) return c.substring(name.length + 1);
    }
    return '';
  }
});

/* --------------------------------------------------
   üîπ Ordenar columnas al hacer clic (ASC / DESC / ORIGINAL)
-------------------------------------------------- */
document.addEventListener('DOMContentLoaded', () => {
  const tables = document.querySelectorAll('.alumnos-table');

  tables.forEach(table => {
    const headers = table.querySelectorAll('thead th');
    const tbody = table.querySelector('tbody');
    const originalRows = Array.from(tbody.querySelectorAll('tr')); // üü° Guardamos el orden original

    headers.forEach((th, index) => {
      if (th.colSpan > 1) return; // Evita las columnas de acciones

      th.style.cursor = 'pointer';
      th.dataset.order = 'none'; // üîπ Estado inicial sin ordenar

      // Etiqueta + flecha visual
      const label = th.textContent.trim();
      th.textContent = '';
      const textSpan = document.createElement('span');
      textSpan.className = 'th-label';
      textSpan.textContent = label;
      const arrow = document.createElement('span');
      arrow.className = 'sort-arrow';
      th.appendChild(textSpan);
      th.appendChild(arrow);

      th.addEventListener('click', () => {
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const isDateColumn = /fecha/i.test(label);
        const currentOrder = th.dataset.order;

        // Limpiar flechas previas
        table.querySelectorAll('.sort-arrow').forEach(el => el.textContent = '');

        // Determinar siguiente estado
        let nextOrder;
        if (currentOrder === 'none') nextOrder = 'asc';
        else if (currentOrder === 'asc') nextOrder = 'desc';
        else nextOrder = 'none'; // üîÅ vuelve al original

        th.dataset.order = nextOrder;

        // Restaurar orden original
        if (nextOrder === 'none') {
          arrow.textContent = '‚Üª';
          tbody.innerHTML = '';
          originalRows.forEach(r => tbody.appendChild(r));
          setTimeout(() => arrow.textContent = '', 500); // Limpia el √≠cono tras 0.5s
          return;
        }

        const direction = nextOrder === 'asc' ? 1 : -1;

        // üî∏ Parsear fechas dd/mm/yyyy o yyyy-mm-dd
        const parseDate = (txt) => {
          const t = txt.trim();
          if (!t) return new Date('1970-01-01');
          if (/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(t)) {
            const [d, m, y] = t.split('/');
            return new Date(`${y.length===2 ? '20'+y : y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`);
          }
          return new Date(t);
        };

        // üî∏ Ordenamiento general
        rows.sort((a, b) => {
          const aTxt = (a.cells[index]?.innerText || '').trim();
          const bTxt = (b.cells[index]?.innerText || '').trim();

          if (isDateColumn) {
            return (parseDate(aTxt) - parseDate(bTxt)) * direction;
          }

          // num√©rico (incluye CUIL)
          const aNum = aTxt.replace(/[^\d.-]/g, '');
          const bNum = bTxt.replace(/[^\d.-]/g, '');
          if (aNum !== '' && bNum !== '' && !isNaN(aNum) && !isNaN(bNum)) {
            return (parseFloat(aNum) - parseFloat(bNum)) * direction;
          }

          // texto
          return aTxt.localeCompare(bTxt, 'es', { sensitivity: 'base', numeric: true }) * direction;
        });

        // Flecha visual seg√∫n orden
        arrow.textContent = nextOrder === 'asc' ? '‚ñ≤' : '‚ñº';

        // Renderizar filas ordenadas
        tbody.innerHTML = '';
        rows.forEach(r => tbody.appendChild(r));
      });
    });
  });
});

</script>
{% endblock %}
