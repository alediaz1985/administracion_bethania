{% extends 'base.html' %}
{% load static %}

{% block title %}Montos por Nivel{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'administracion/css/monto_nivel/styles_montos_nivel.css' %}">
{% endblock %}

{% block content %}
<div class="montos-container">

  <!-- üîπ CABECERA -->
  <div class="montos-header">
    <div class="montos-titulo">
      <h2>Montos por Nivel</h2>
      <p class="subtitulo">Gestione los valores de las cuotas seg√∫n el nivel educativo</p>
    </div>

    <div class="montos-botones">
      <a href="{% url 'administracion:home_administracion' %}" class="btn-volver">
        Volver
      </a>
      <button class="btn-nuevo" id="btnAdd">Nuevo Monto</button>
    </div>
  </div>

  <!-- üîπ FILTROS -->
  <div class="montos-filtros mb-3 d-flex align-items-center justify-content-between">
    <div class="filtro-ciclo d-flex align-items-center gap-2">
      <label for="cicloFilter" class="fw-semibold">Ciclo:</label>
      <select id="cicloFilter" class="form-select form-select-sm" style="width: 150px;">
        <option value="">Todos</option>
        {% for ciclo in ciclos %}
          <option value="{{ ciclo.id }}"
            {% if ciclo_actual and ciclo.id == ciclo_actual.id %}selected{% endif %}>
            {{ ciclo.anio }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="filtro-activos form-check">
      <input class="form-check-input" type="checkbox" id="checkActivos">
      <label class="form-check-label fw-semibold" for="checkActivos">Mostrar solo activos</label>
    </div>
  </div>

  <!-- üîπ TABLA -->
  <div id="tabla-montos" class="tabla-container">
    {% include 'administracion/monto_nivel/_tabla.html' %}
  </div>
</div>

<!-- üîπ MODAL -->
<div id="modalMonto" class="modal fade" tabindex="-1"></div>
{% endblock %}

{% block extra_js %}
<script>
  let sortCol = "ciclo__anio";
  let sortDir = "desc";

  // =============================
  // üß© FUNCIONES DE MODAL
  // =============================
  function loadModal(url) {
    fetch(url)
      .then(r => r.json())
      .then(data => {
        const modalDiv = document.getElementById("modalMonto");
        modalDiv.innerHTML = data.html_form;
        const modal = new bootstrap.Modal(modalDiv);
        modal.show();

        const form = modalDiv.querySelector("form");
        if (form) handleSubmit(form, url, modal, modalDiv);
      });
  }

  function handleSubmit(form, url, modal, modalDiv) {
    form.addEventListener("submit", e => {
      e.preventDefault();
      fetch(url, { method: "POST", body: new FormData(form) })
        .then(r => r.json())
        .then(data => {
          if (data.form_is_valid) {
            document.getElementById("tabla-montos").innerHTML = data.html_list;
            modal.hide();
            inicializarEventos();
            actualizarIndicadoresOrden(); // üß≠ mantiene las flechas correctas
          } else {
            modalDiv.innerHTML = data.html_form;
            const newForm = modalDiv.querySelector("form");
            if (newForm) handleSubmit(newForm, url, modal, modalDiv);
          }
        });
    });
  }

  // =============================
  // üéØ FILTROS AJAX
  // =============================
  const cicloFilter = document.getElementById("cicloFilter");
  const checkActivos = document.getElementById("checkActivos");

  function aplicarFiltros() {
    const ciclo = cicloFilter.value;
    const activos = checkActivos.checked ? 1 : 0;

    const url = `{% url 'administracion:filtrar_montos' %}?ciclo=${ciclo}&activos=${activos}&sort_col=${sortCol}&sort_dir=${sortDir}`;
    fetch(url)
      .then(r => r.text())
      .then(html => {
        document.getElementById("tabla-montos").innerHTML = html;
        inicializarEventos();
        actualizarIndicadoresOrden(); // ‚úÖ se vuelve a marcar la columna ordenada
      });
  }

  // =============================
// ‚öôÔ∏è FUNCI√ìN CENTRAL DE EVENTOS
// =============================
function inicializarEventos() {
  // üü¶ Bot√≥n "Nuevo Monto"
  const btnAdd = document.getElementById("btnAdd");
  if (btnAdd) {
    const clone = btnAdd.cloneNode(true);
    btnAdd.parentNode.replaceChild(clone, btnAdd);
    clone.addEventListener("click", () => loadModal("{% url 'administracion:crear_monto' %}"));
  }

  // üü© Botones de editar y eliminar
  document.querySelectorAll(".js-edit, .js-delete").forEach(btn => {
    const clone = btn.cloneNode(true);
    btn.parentNode.replaceChild(clone, btn);
    clone.addEventListener("click", e => {
      e.preventDefault();
      loadModal(clone.dataset.url);
    });
  });

  // üü® Ordenamiento por columnas
  document.querySelectorAll("th.sortable").forEach(th => {
    const clone = th.cloneNode(true);
    th.parentNode.replaceChild(clone, th);
    clone.addEventListener("click", () => {
      const col = clone.dataset.col;

      if (col === sortCol) {
        sortDir = sortDir === "asc" ? "desc" : "asc";
      } else {
        sortCol = col;
        sortDir = "asc";
      }

      aplicarFiltros();
    });
  });
}

  // =============================
  // üß≠ INDICADORES VISUALES (persistentes)
  // =============================
  function actualizarIndicadoresOrden() {
    document.querySelectorAll("th.sortable").forEach(th => {
      const col = th.dataset.col;
      const icon = th.querySelector(".sort-icon");

      // üîπ si no tiene √≠cono, lo creamos una vez
      if (!icon) {
        const span = document.createElement("span");
        span.classList.add("sort-icon");
        span.style.marginLeft = "6px";
        span.style.opacity = "0.6";
        th.appendChild(span);
      }
    });

    document.querySelectorAll(".sort-icon").forEach(icon => (icon.textContent = "‚áÖ"));

    // üîπ solo la columna actual muestra ‚ñ≤ o ‚ñº
    const activeTh = document.querySelector(`th[data-col="${sortCol}"] .sort-icon`);
    if (activeTh) activeTh.textContent = sortDir === "asc" ? "‚ñ≤" : "‚ñº";
  }

  // =============================
  // üöÄ AL CARGAR LA P√ÅGINA
  // =============================
  document.addEventListener("DOMContentLoaded", () => {
    inicializarEventos();
    actualizarIndicadoresOrden();

    cicloFilter.addEventListener("change", aplicarFiltros);
    checkActivos.addEventListener("change", aplicarFiltros);

    if (cicloFilter.value) aplicarFiltros();
  });
</script>
{% endblock %}
