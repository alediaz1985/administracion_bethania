{% extends "base.html" %}
{% load static %}

{% block title %}Gesti√≥n de Ciclos Lectivos{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'cuotas/css/ciclos.css' %}">
{% endblock %}

{% block content %}
<div class="student-card cuotas-card">
  <!-- CABECERA -->
  <div class="student-header cuotas-header">
    <div>
      <h2>üìÖ Gesti√≥n de Ciclos Lectivos</h2>
      <p class="cuotas-header__subtitle">Cre√°, activ√° y administr√° los ciclos lectivos.</p>
    </div>
    <div class="student-actions">
      <!-- Botones tipo button para evitar submits involuntarios -->
      <button class="btn" type="button" data-jump="tab-crear">Nuevo ciclo</button>
      <button class="btn btn-light" type="button" data-jump="tab-listado">Ver listado</button>
    </div>
  </div>

  <!-- ESTADO ACTUAL -->
  {% if CUOTAS_CICLO_ACTIVO %}
    <div class="status aprobado">
      <strong>Ciclo activo:</strong> {{ CUOTAS_CICLO_ACTIVO.anio }}
      <span class="muted">({{ CUOTAS_CICLO_ACTIVO.fecha_inicio|date:"d/m/Y" }} ‚Üí {{ CUOTAS_CICLO_ACTIVO.fecha_fin|date:"d/m/Y" }})</span>
    </div>
  {% else %}
    <div class="status pendiente">
      <strong>No hay ciclo activo.</strong> Cre√° o activ√° uno nuevo.
    </div>
  {% endif %}

  <!-- PESTA√ëAS -->
  <div class="tabs" role="tablist" aria-label="Ciclos lectivos">
    <button class="tab-button active" type="button" role="tab" data-tab="tab-crear" aria-selected="true">‚ûï Crear ciclo</button>
    <button class="tab-button" type="button" role="tab" data-tab="tab-listado" aria-selected="false">üìò Ciclos existentes</button>
  </div>

  <!-- CREAR -->
  <section id="tab-crear" class="tab-content active" role="tabpanel">
<form method="post" action="{% url 'cuotas:ciclo_create' %}" class="form-grid" id="form-crear-ciclo">
    {% csrf_token %}
    {{ form.as_p }}
    <div class="form-actions">
        <button class="btn" type="submit" id="btn-crear">Crear Ciclo</button>
        <span class="hint">Atajos: <kbd>N</kbd> ‚ÄúNuevo‚Äù ¬∑ <kbd>S</kbd> guardar</span>
    </div>
</form>

  </section>

  <!-- LISTADO -->
  <section id="tab-listado" class="tab-content" role="tabpanel" aria-hidden="true">
    <div class="table-wrap">
      <table class="table-like">
        <thead>
          <tr>
            <th>A√±o</th>
            <th>Fecha Inicio</th>
            <th>Fecha Fin</th>
            <th>Estado</th>
            <th class="col-actions">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for ciclo in ciclos %}
          <tr>
            <td>{{ ciclo.anio }}</td>
            <td>{{ ciclo.fecha_inicio|date:"d/m/Y" }}</td>
            <td>{{ ciclo.fecha_fin|date:"d/m/Y" }}</td>
            <td>
              {% if ciclo.activo %}
                <span class="badge success">Activo</span>
              {% else %}
                <span class="badge muted">Inactivo</span>
              {% endif %}
            </td>
            <td class="col-actions">
              {% if not ciclo.activo %}
                <a href="{% url 'cuotas:activar_ciclo' ciclo.id %}" class="btn btn-light btn-xs">Activar</a>
              {% else %}
                <button class="btn btn-xs" disabled>Activo</button>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="empty">No hay ciclos creados a√∫n.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="hint mt-8">Atajos: <kbd>L</kbd> ir a ‚ÄúListado‚Äù</div>
  </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function(){
  if (window.__ciclosInit) return;
  window.__ciclosInit = true;

  function activate(id){
    document.querySelectorAll('.tab-button').forEach(b=>{
      const on = b.dataset.tab === id;
      b.classList.toggle('active', on);
      b.setAttribute('aria-selected', on ? 'true':'false');
    });
    document.querySelectorAll('.tab-content').forEach(p=>{
      const on = p.id === id;
      p.classList.toggle('active', on);
      p.setAttribute('aria-hidden', on ? 'false':'true');
    });
  }

  // Delegaci√≥n de clicks
  document.addEventListener('click', function(e){
    const jump = e.target.closest('[data-jump]');
    if (jump){
      e.preventDefault();
      activate(jump.getAttribute('data-jump'));
      document.querySelector('.student-card')?.scrollIntoView({ behavior:'smooth', block:'start' });
      return;
    }
    const tab = e.target.closest('.tab-button');
    if (tab){
      e.preventDefault();
      activate(tab.dataset.tab);
      return;
    }
  }, true);

  // Atajos: N (nuevo), L (listado), S (submit si est√°s en "crear")
  document.addEventListener('keydown', function(e){
    const tag = (document.activeElement?.tagName || '').toUpperCase();
    if (['INPUT','TEXTAREA','SELECT','BUTTON'].includes(tag)) return;

    const k = e.key.toLowerCase();
    if (k === 'n') activate('tab-crear');
    if (k === 'l') activate('tab-listado');
    if (k === 's'){
      const crearVisible = document.getElementById('tab-crear')?.classList.contains('active');
      if (crearVisible) document.getElementById('form-crear-ciclo')?.requestSubmit();
    }
  });

  // Reenganche si us√°s Turbo/HTMX
  document.addEventListener('turbo:load', () => activate('tab-crear'));
  document.addEventListener('htmx:afterSettle', () => activate('tab-crear'));
})();
</script>
{% endblock %}
