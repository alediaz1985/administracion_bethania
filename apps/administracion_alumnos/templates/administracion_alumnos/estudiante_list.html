{% extends 'base.html' %}

{% block title %}Lista de Alumnos{% endblock %}

{% load static %}

{% block extra_styles %}
    <link rel="stylesheet" href="../../static/administracion_alumnos/css/styles_listar_alumnos.css">
{% endblock %}

{% block content %}

<div class="alumnos-container">
    <div class="alumnos">
        <!-- üîπ Filtro a la izquierda -->
        <div class="filters">
            <select id="nivel-filter" name="nivel">
                <option value="">Seleccionar Nivel</option>
                <option value="Inicial">Nivel Inicial</option>
                <option value="Primario">Nivel Primario</option>
                <option value="Secundario">Nivel Secundario</option>
            </select>
        </div>

        <!-- üîπ Botones a la derecha -->
        <div class="actions">
            <form action="{% url 'generar_pdf_lista_alumnos' %}" method="get">
                <button type="submit" class="btn-minimal" title="Generar PDF">
                    <i class="fas fa-file-pdf"></i>
                    <span>Generar PDF</span>
                </button>
            </form>

            <!-- ‚úÖ Bot√≥n de actualizaci√≥n -->
            <button type="button" id="btn-refresh" class="btn-minimal" title="Actualizar datos" onclick="refrescarDatos()">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>
    
    <div class="tabs">
        <button class="tab-button active" onclick="showTab('todos')">Todos</button>
        <button class="tab-button" onclick="showTab('pendientes')">Pendientes</button>
        <button class="tab-button" onclick="showTab('aprobados')">Aprobados</button>
    </div>
    <div class="alumnos-scroll-container">
        <div class="tab-content active" id="todos">
            <table class="alumnos-table" id="data-table">
                <thead>
                    <tr>
                        <th>CUIL</th>
                        <th>Apellido/s</th>
                        <th>Nombre/s</th>
                        <th>Nivel</th>
                        <th>Subnivel</th>
                        <th>Turno</th>
                        <th>Fecha Recepci√≥n</th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    {% if estudiantes %}
                        {% for estudiante in estudiantes %}
                            <tr data-nivel="{{ estudiante.inscripcion.nivel_estudiante }}" 
                                data-turno="{{ estudiante.inscripcion.turno_estudiante }}">
                                
                                <td>
                                    <span id="cuil_{{ estudiante.id }}">{{ estudiante.cuil_estudiante }}</span>
                                    <button onclick="copyToClipboard('cuil_{{ estudiante.id }}')" style="border: none; background: transparent; cursor: pointer;">
                                        <i class="fas fa-copy" style="color: #b6b6b6;"></i>
                                    </button>
                                </td>

                                <td>{{ estudiante.apellidos_estudiante }}</td>
                                <td>{{ estudiante.nombres_estudiante }}</td>
                                <td>{{ estudiante.inscripcion.nivel_estudiante }}</td>
                                <td>{{ estudiante.inscripcion.curso_anio_estudiante }}</td>
                                <td>{{ estudiante.inscripcion.turno_estudiante }}</td>
                                <td>{{ estudiante.inscripcion.fecha_recepcion }}</td>

                                <td class="acciones">
                                    <form action="{% url 'ver_datos_estudiante' pk=estudiante.pk %}" method="get" class="icon-form">
                                        <button class="icon-btn" title="Ver datos" type="submit">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </form>
                                    <form action="{% url 'generar_contrato' estudiante.pk %}" method="get" class="icon-form">
                                        <button class="icon-btn pdf" title="Generar contrato PDF" type="submit">
                                            <i class="fas fa-file-pdf"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8">No hay alumnos en la base de datos.</td>
                        </tr>
                    {% endif %}
                <tbody>
            </table>
        </div>
        <div class="tab-content" id="pendientes">
            <table class="alumnos-table" id="data-table">
                <thead>
                    <tr>
                        <th>CUIL</th>
                        <th>Apellido/s</th>
                        <th>Nombre/s</th>
                        <th>Nivel</th>
                        <th>Grado</th>
                        <th>Turno</th>
                        <th>Fecha Recepci√≥n</th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Filas de datos iniciales -->
                    {% if estudiantes_pendientes %}
                        {% for estudiante in estudiantes_pendientes %}
                            <tr data-nivel="{{ estudiante.nivel_estudiante }}" 
                            data-subnivel="{{ estudiante.subnivel_estudiante }}" 
                            data-turno="{{ estudiante.turno_estudiante }}">
                                <td>
                                    <span id="datoCuil_{{ estudiante.id }}">{{ estudiante.cuil_estudiante }}</span>
                                    <button onclick="duplicarAlPortapapeles('datoCuil_{{ estudiante.id }}')" style="border: none; background: transparent; cursor: pointer;">
                                        <i class="fas fa-copy" style="color: #b6b6b6;"></i> <!-- Icono con un color distinto si quer√©s -->
                                    </button>
                                </td>
                                
                                <!-- Segundo toast (mensaje flotante alternativo) -->
                                <div id="avisoCopiado_{{ estudiante.id }}" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 128, 0, 0.8); color: white; padding: 10px 20px; border-radius: 5px; font-size: 14px; display: none; opacity: 0; pointer-events: none; z-index: 9999; transition: opacity 0.5s ease;">
                                    ¬°Copiado!
                                </div>
                            
                                <td>{{ estudiante.apellidos_estudiante }}</td>
                                <td>{{ estudiante.nombres_estudiante }}</td>
                                <td>{{ estudiante.inscripcion.nivel_estudiante }}</td>
                                <td>{{ estudiante.inscripcion.curso_anio_estudiante }}</td>
                                <td>{{ estudiante.inscripcion.turno_estudiante }}</td>
                                <td>{{ estudiante.inscripcion.fecha_recepcion }}</td>

                                <td class="acciones">
                                    <form action="{% url 'ver_datos_estudiante' pk=estudiante.pk %}" method="get" class="icon-form">
                                        <button class="icon-btn" title="Ver datos" type="submit">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </form>
                                    <form action="{% url 'generar_contrato' estudiante.pk %}" method="get" class="icon-form">
                                        <button class="icon-btn pdf" title="Generar contrato PDF" type="submit">
                                            <i class="fas fa-file-pdf"></i>
                                        </button>
                                    </form>
                                </td>                              
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5">No hay alumnos en la base de datos.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        <div class="tab-content" id="aprobados">
            <table class="alumnos-table" id="data-table">
                <thead>
                    <tr>
                        <th>CUIL</th>
                        <th>Apellido/s</th>
                        <th>Nombre/s</th>
                        <th>Nivel</th>
                        <th>Grado</th>
                        <th>Turno</th>
                        <th>Fecha Recepci√≥n</th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    {% if estudiantes_aprobados %}
                        {% for estudiante in estudiantes_aprobados %}
                            <tr data-nivel="{{ estudiante.nivel_estudiante }}" 
                            data-subnivel="{{ estudiante.subnivel_estudiante }}" 
                            data-turno="{{ estudiante.turno_estudiante }}">
                                <td>
                                    <span id="identificadorCuil_{{ estudiante.id }}">{{ estudiante.cuil_estudiante }}</span>
                                    <button onclick="copiarValorCuil('identificadorCuil_{{ estudiante.id }}')" style="border: none; background: transparent; cursor: pointer;">
                                        <i class="fas fa-copy" style="color: #b6b6b6;"></i> <!-- Color diferente -->
                                    </button>
                                </td>
                                
                                <!-- Tercer toast (mensaje personalizado) -->
                                <div id="mensajeCuil_{{ estudiante.id }}" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 128, 0, 0.8); color: white; padding: 10px 20px; border-radius: 5px; font-size: 14px; display: none; opacity: 0; pointer-events: none; z-index: 9999; transition: opacity 0.5s ease;">
                                    ¬°Copiado!
                                </div>
                            
                                <td>{{ estudiante.apellidos_estudiante }}</td>
                                <td>{{ estudiante.nombres_estudiante }}</td>
                                <td>{{ estudiante.inscripcion.nivel_estudiante }}</td>
                                <td>{{ estudiante.inscripcion.curso_anio_estudiante }}</td>
                                <td>{{ estudiante.inscripcion.turno_estudiante }}</td>
                                <td>{{ estudiante.inscripcion.fecha_recepcion }}</td>

                                <td class="acciones">
                                <a class="icon-btn" title="Ver datos" href="{% url 'ver_datos_estudiante' pk=estudiante.pk %}">
                                    <i class="fas fa-search"></i>
                                </a>
                                <a class="icon-btn pdf" title="Generar contrato PDF" href="{% url 'generar_contrato' estudiante.pk %}" target="_blank" rel="noopener">
                                    <i class="fas fa-file-pdf"></i>
                                </a>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5">No hay alumnos aprobados.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>

function showTab(tabName) {
    // Ocultar todas las pesta√±as
    const tabs = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => tab.classList.remove('active'));
    
    // Mostrar la pesta√±a seleccionada
    const activeTab = document.getElementById(tabName);
    activeTab.classList.add('active');
    
    // Cambiar estilo de botones
    const buttons = document.querySelectorAll('.tab-button');
    buttons.forEach(button => button.classList.remove('active'));
    const activeButton = document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`);
    activeButton.classList.add('active');
}

document.addEventListener('DOMContentLoaded', function() {
    let dateElements = document.querySelectorAll('.fecha');
    dateElements.forEach(function(el) {
        let dateValue = el.textContent.trim();
        if (dateValue) {
            let date = new Date(dateValue);
            // Verificar si la fecha es v√°lida
            if (!isNaN(date)) {
                el.textContent = date.toLocaleDateString('es-AR'); // dd/mm/yyyy
            } else {
                el.textContent = ''; // Dejar vac√≠o si la fecha es inv√°lida
            }
        } else {
            el.textContent = ''; // Dejar vac√≠o si no hay valor
        }
    });
});

document.addEventListener('DOMContentLoaded', function() {
    // Filtro
    const nivelFilter = document.getElementById('nivel-filter');
    const tableRows = document.querySelectorAll('#table-body tr');

    // Funci√≥n para filtrar la tabla seg√∫n el filtro de nivel
    nivelFilter.addEventListener('change', filterTable);

    // Funci√≥n para filtrar la tabla
    function filterTable() {
        const nivel = nivelFilter.value.toLowerCase();

        tableRows.forEach(function(row) {
            const rowNivel = row.getAttribute('data-nivel').toLowerCase();

            // Mostrar o ocultar la fila seg√∫n el filtro de nivel
            const showRow = (nivel === "" || rowNivel.includes(nivel));
            row.style.display = showRow ? "" : "none";
        });
    }

    // Filtrar cuando cambie el filtro de nivel
    filterTable();
});

function copyToClipboard(id) {
    var copyText = document.getElementById(id);
    var range = document.createRange();
    range.selectNode(copyText);
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);
    document.execCommand('copy');
    window.getSelection().removeAllRanges();

    // Mostrar el mensaje flotante
    var toast = document.getElementById('toast_' + id.split('_')[1]);
    toast.style.display = 'block'; // Mostrar el toast
    toast.style.opacity = 1; // Hacerlo visible

    // Desaparecer despu√©s de 2 segundos
    setTimeout(function() {
      toast.style.opacity = 0; // Hacerlo desaparecer
      setTimeout(function() {
        toast.style.display = 'none'; // Ocultarlo completamente despu√©s de la animaci√≥n
      }, 500); // Esperar el tiempo de la animaci√≥n
    }, 2000);
}

function duplicarAlPortapapeles(elementoId) {
    var contenido = document.getElementById(elementoId);
    var campoTemporal = document.createElement("textarea");
    campoTemporal.value = contenido.textContent;
    document.body.appendChild(campoTemporal);
    campoTemporal.select();
    document.execCommand("copy");
    document.body.removeChild(campoTemporal);

    // Mostrar el mensaje personalizado
    var idEstudiante = elementoId.split('_')[1];
    var aviso = document.getElementById("avisoCopiado_" + idEstudiante);
    aviso.style.display = "block";
    aviso.style.opacity = "1";

    setTimeout(function() {
        aviso.style.opacity = "0";
        setTimeout(function() {
            aviso.style.display = "none";
        }, 500);
    }, 2000);
}

function copiarValorCuil(refId) {
    const valor = document.getElementById(refId);
    const tempInput = document.createElement("textarea");
    tempInput.value = valor.textContent;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand("copy");
    document.body.removeChild(tempInput);

    // Mostrar mensaje personalizado
    const estudianteId = refId.split('_')[1];
    const alerta = document.getElementById("mensajeCuil_" + estudianteId);
    alerta.style.display = "block";
    alerta.style.opacity = "1";

    setTimeout(() => {
        alerta.style.opacity = "0";
        setTimeout(() => {
            alerta.style.display = "none";
        }, 500);
    }, 2000);
}

function refrescarDatos() {
    const btn = document.getElementById('btn-refresh');
    const icon = btn.querySelector('i');

    btn.classList.add('loading');
    btn.disabled = true;

    fetch(window.location.href, { cache: "no-store" })
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newTable = doc.querySelector('.alumnos-scroll-container');
            document.querySelector('.alumnos-scroll-container').innerHTML = newTable.innerHTML;

            mostrarToast("‚úÖ Datos actualizados correctamente");
        })
        .catch(error => {
            console.error('Error al actualizar los datos:', error);
            mostrarToast("‚ùå Error al actualizar los datos");
        })
        .finally(() => {
            btn.classList.remove('loading');
            btn.disabled = false;
        });
}

</script>

{% endblock %}
