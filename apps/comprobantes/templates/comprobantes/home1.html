{% extends "base.html" %}
{% load static %}

{% block title %}Comprobantes & Documentos{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- Encabezado -->
  <div class="d-flex align-items-center justify-content-between mb-4">
    <div>
      <h2 class="m-0">Comprobantes & Documentos</h2>
      <p class="text-muted mb-0">Centro de acciones: búsqueda, subida y sincronización con Google Drive.</p>
    </div>
    <a href="{% url 'comprobantes:list_files' %}" target="_blank" class="btn btn-outline-secondary btn-sm" data-bs-toggle="tooltip" title="Ver JSON con archivos en la carpeta configurada">
      <i class="bi bi-code"></i> Listar (JSON)
    </a>
  </div>

  <!-- Grid de acciones -->
  <div class="row g-3">
    <!-- Buscar local -->
    <div class="col-12 col-md-6 col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center mb-2">
            <div class="me-2 fs-4"><i class="bi bi-search"></i></div>
            <h5 class="card-title mb-0">Búsqueda local</h5>
          </div>
          <p class="text-muted mb-3">
            Busca términos dentro de PDFs, imágenes (OCR), DOCX y XLSX en tu carpeta local <code>ARCHIVOS_DIR</code>.
          </p>
          <div class="mt-auto">
            <a href="{% url 'comprobantes:consulta' %}" class="btn btn-primary w-100">
              Ir a búsqueda local
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Buscar en Drive -->
    <div class="col-12 col-md-6 col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center mb-2">
            <div class="me-2 fs-4"><i class="bi bi-cloud-check"></i></div>
            <h5 class="card-title mb-0">Búsqueda en Google Drive</h5>
          </div>
          <p class="text-muted mb-3">
            Filtra por nombre y por fechas de modificación en la carpeta de Google Drive configurada.
          </p>
          <div class="mt-auto">
            <a href="{% url 'comprobantes:consulta_comprobantes' %}" class="btn btn-primary w-100">
              Ir a búsqueda en Drive
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Subir comprobante -->
    <div class="col-12 col-md-6 col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center mb-2">
            <div class="me-2 fs-4"><i class="bi bi-upload"></i></div>
            <h5 class="card-title mb-0">Subir comprobante</h5>
          </div>
          <p class="text-muted mb-3">
            Carga manualmente un comprobante (usa tu <code>DocumentoForm</code>).
          </p>
          <div class="mt-auto">
            <a href="{% url 'comprobantes:subir_comprobante' %}" class="btn btn-outline-primary w-100">
              Subir ahora
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Descargar desde Drive -->
    <div class="col-12 col-md-6 col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center mb-2">
            <div class="me-2 fs-4"><i class="bi bi-download"></i></div>
            <h5 class="card-title mb-0">Descargar desde Google Drive</h5>
          </div>
          <p class="text-muted mb-3">
            Descarga todos los archivos nuevos de la carpeta de Drive a <code>/media/documentos/descargados</code>.
          </p>

          <!-- Botón que abre modal de confirmación -->
          <button class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#modalDescargar">
            Descargar ahora
          </button>

          <!-- Modal confirmar descarga -->
          <div class="modal fade" id="modalDescargar" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <form method="post" action="{% url 'comprobantes:descargar_archivos_nube' %}">
                  {% csrf_token %}
                  <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-download"></i> Confirmar descarga</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                  </div>
                  <div class="modal-body">
                    ¿Deseás descargar los archivos desde Google Drive? Se omitirán los que ya existan con el mismo nombre destino.
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Sí, descargar</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Link a último resumen -->
          <a href="{% url 'comprobantes:exito_descarga' %}" class="btn btn-link mt-2 w-100">
            Ver último resumen de descargas
          </a>
        </div>
      </div>
    </div>

    <!-- Vaciar carpeta de Drive -->
    <div class="col-12 col-md-6 col-xl-4">
      <div class="card shadow-sm h-100 border-danger-subtle">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center mb-2">
            <div class="me-2 fs-4 text-danger"><i class="bi bi-trash"></i></div>
            <h5 class="card-title mb-0 text-danger">Vaciar carpeta de Drive</h5>
          </div>
          <p class="text-muted mb-3">
            <strong>Acción destructiva:</strong> elimina <u>todos</u> los archivos de la carpeta remota (no del servidor).
          </p>

          <!-- Botón que abre modal de confirmación -->
          <button class="btn btn-outline-danger w-100" data-bs-toggle="modal" data-bs-target="#modalVaciar">
            Vaciar carpeta (Drive)
          </button>

          <!-- Modal confirmar vaciado -->
          <div class="modal fade" id="modalVaciar" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <form method="post" action="{% url 'comprobantes:vaciar_carpeta_drive' %}">
                  {% csrf_token %}
                  <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Confirmar vaciado</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                  </div>
                  <div class="modal-body">
                    Esta acción eliminará <strong>todos</strong> los archivos de la carpeta de Google Drive configurada. ¿Seguro?
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Sí, vaciar</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="small text-muted mt-2">
            Consejo: hacé un backup antes de vaciar.
          </div>
        </div>
      </div>
    </div>

    <!-- Ayuda / Documentación -->
    <div class="col-12 col-md-6 col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center mb-2">
            <div class="me-2 fs-4"><i class="bi bi-info-circle"></i></div>
            <h5 class="card-title mb-0">Ayuda rápida</h5>
          </div>
          <ul class="text-muted small mb-3">
            <li><strong>Búsqueda local:</strong> inspecciona contenido con OCR y texto.</li>
            <li><strong>Drive:</strong> consulta por nombre y rango de fechas.</li>
            <li><strong>Descargar:</strong> guarda en <code>/media/documentos/descargados</code>.</li>
            <li><strong>Vaciar Drive:</strong> elimina archivos remotos.</li>
          </ul>
          <div class="mt-auto">
            <a href="{% url 'comprobantes:consulta' %}" class="btn btn-light w-100">Ver más opciones</a>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /row -->

</div>

<!-- Bootstrap Icons (si no los tenés ya incluidos en base.html) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
      new bootstrap.Tooltip(tooltipTriggerEl)
    })
  });
</script>
{% endblock %}
