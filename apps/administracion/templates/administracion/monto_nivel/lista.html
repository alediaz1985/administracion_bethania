{% extends 'base.html' %}
{% load static %}

{% block title %}Montos por Nivel{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'administracion/css/monto_nivel/styles_montos_nivel.css' %}">
{% endblock %}

{% block content %}
<div class="montos-container">

  <!-- üîπ CABECERA -->
  <div class="montos-header">
    <div class="montos-titulo">
      <h2>Montos por Nivel</h2>
      <p class="subtitulo">Gestione los valores de las cuotas seg√∫n el nivel educativo</p>
    </div>

    <div class="montos-botones">
      <!-- üî∏ Bot√≥n Volver -->
      <a href="{% url 'administracion:home_administracion' %}" class="btn-volver">
        Volver
      </a>

      <!-- üî∏ Bot√≥n Nuevo Monto -->
      <button class="btn-nuevo" id="btnAdd">
        Nuevo Monto
      </button>
    </div>
  </div>

  <!-- üîπ FILTROS -->
  <div class="montos-filtros mb-3 d-flex align-items-center justify-content-between">
    <div class="filtro-ciclo d-flex align-items-center gap-2">
      <label for="cicloFilter" class="fw-semibold">Ciclo:</label>
      <select id="cicloFilter" class="form-select form-select-sm" style="width: 150px;">
        <option value="">Todos</option>
        {% for ciclo in ciclos %}
          <option value="{{ ciclo.id }}" 
            {% if ciclo_actual and ciclo.id == ciclo_actual.id %}selected{% endif %}>
            {{ ciclo.anio }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="filtro-activos form-check">
      <input class="form-check-input" type="checkbox" id="checkActivos">
      <label class="form-check-label fw-semibold" for="checkActivos">
        Mostrar solo activos
      </label>
    </div>
  </div>

  <!-- üîπ TABLA -->
  <div id="tabla-montos" class="tabla-container">
    {% include 'administracion/monto_nivel/_tabla.html' %}
  </div>
</div>

<!-- üîπ MODAL -->
<div id="modalMonto" class="modal fade" tabindex="-1"></div>
{% endblock %}

{% block extra_js %}
<script>
  // =============================
  // üß© FUNCIONES DE MODAL
  // =============================
  function loadModal(url) {
    fetch(url)
      .then(r => r.json())
      .then(data => {
        const modalDiv = document.getElementById("modalMonto");
        modalDiv.innerHTML = data.html_form;

        const modal = new bootstrap.Modal(modalDiv);
        modal.show();

        function handleSubmit(form) {
          form.addEventListener("submit", function (e) {
            e.preventDefault();
            fetch(url, { method: "POST", body: new FormData(form) })
              .then(r => r.json())
              .then(data => {
                if (data.form_is_valid) {
                  document.getElementById("tabla-montos").innerHTML = data.html_list;
                  modal.hide();
                } else {
                  modalDiv.innerHTML = data.html_form;
                  const newForm = modalDiv.querySelector("form");
                  if (newForm) handleSubmit(newForm);
                }
              });
          });
        }

        const form = modalDiv.querySelector("form");
        if (form) handleSubmit(form);
      });
  }

  // ‚ûï Crear
  document.getElementById("btnAdd").addEventListener("click", () => {
    loadModal("{% url 'administracion:crear_monto' %}");
  });

  // ‚úèÔ∏è Editar / üóëÔ∏è Eliminar
  document.addEventListener("click", e => {
    const editBtn = e.target.closest(".js-edit");
    const delBtn = e.target.closest(".js-delete");
    if (editBtn) loadModal(editBtn.dataset.url);
    if (delBtn) loadModal(delBtn.dataset.url);
  });

  // =============================
  // üéØ FILTROS AJAX
  // =============================
  const cicloFilter = document.getElementById("cicloFilter");
  const checkActivos = document.getElementById("checkActivos");

  function aplicarFiltros() {
    const ciclo = cicloFilter.value;
    const activos = checkActivos.checked ? 1 : 0; // ‚úÖ solo si est√° marcado

    fetch(`{% url 'administracion:filtrar_montos' %}?ciclo=${ciclo}&activos=${activos}`)
      .then(r => r.text())
      .then(html => {
        document.getElementById("tabla-montos").innerHTML = html;
      });
  }

  cicloFilter.addEventListener("change", aplicarFiltros);
  checkActivos.addEventListener("change", aplicarFiltros);

  // =============================
  // üöÄ FILTRO AUTOM√ÅTICO AL CARGAR
  // =============================
  document.addEventListener("DOMContentLoaded", () => {
    // üß© Si hay un ciclo seleccionado por defecto, lo aplica autom√°ticamente
    if (cicloFilter && cicloFilter.value) {
      aplicarFiltros();
    }
  });
</script>
{% endblock %}

