{% extends 'base.html' %}
{% load static %}

{% block title %}Asignar Beca a Estudiante{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'administracion/css/beca/styles_asignar_beca.css' %}">
{% endblock %}

{% block content %}
<div class="asignar-beca-container">

  <!-- üîπ CABECERA -->
  <div class="asignar-header">
    <div class="asignar-titulo">
      <h2>Asignar Beca a Estudiante</h2>
      <p class="subtitulo">Seleccione la beca que desea otorgar a cada estudiante</p>
    </div>

    <a href="{% url 'administracion:estudiantes_becas_activas' %}" class="btn-volver">
      Volver
    </a>
  </div>

  <!-- üîπ FILTROS -->
  <div class="filtros-container mb-3">
    <div class="filtros-row">

      <!-- Ciclo -->
      <div class="filtro">
        <label for="ciclo">Ciclo</label>
        <select id="ciclo" class="form-select form-select-sm">
          <option value="">Todos</option>
          {% for c in ciclos %}
            <option value="{{ c.anio }}">{{ c.anio }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Nivel -->
      <div class="filtro">
        <label for="nivel">Nivel</label>
        <select id="nivel" class="form-select form-select-sm">
          <option value="">Todos</option>
          {% for n in niveles %}
            <option value="{{ n.nombre }}">{{ n.nombre }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Buscador -->
      <div class="filtro filtro-buscar">
        <label for="buscar">Buscar</label>
        <input type="text" id="buscar" class="form-control form-control-sm"
               placeholder="Nombre o Apellido">
      </div>
    </div>
  </div>

  <!-- üîπ MENSAJES -->
  {% if messages %}
    {% for msg in messages %}
      <div class="alert alert-{{ msg.tags }}">{{ msg }}</div>
    {% endfor %}
  {% endif %}

  <!-- üîπ TABLA -->
  {% if inscripciones %}
  <table class="asignar-table">
    <thead>
      <tr>
        <th>Estudiante</th>
        <th>Ciclo</th>
        <th>Nivel</th>
        <th>Seleccionar Beca</th>
        <th>Acci√≥n</th>
      </tr>
    </thead>
    <tbody>
      {% for ins in inscripciones %}
      <tr>
        <td>{{ ins.estudiante.apellidos_estudiante }}, {{ ins.estudiante.nombres_estudiante }}</td>
        <td>{{ ins.ciclo.anio }}</td>
        <td>{{ ins.nivel.nombre }}</td>

        <td class="col-select">
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="inscripcion_id" value="{{ ins.id }}">
            <select name="beca_id" class="form-select-sm" required>
              <option value="">-- Seleccionar --</option>
              {% for b in becas %}
                <option value="{{ b.id }}">{{ b.nombre }} ({{ b.tipo }} - {{ b.valor }})</option>
              {% endfor %}
            </select>
        </td>

        <td class="col-accion">
            <button type="submit" class="icon-btn asignar" title="Asignar Beca">
              <i class="fas fa-check"></i>
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <div class="alert alert-info">
      Todos los estudiantes ya tienen una beca asignada.
    </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// ============================================================
// üéØ FILTROS DIN√ÅMICOS (Ciclo, Nivel, Buscar) ‚Äî con soporte de tildes
// ============================================================
document.addEventListener("DOMContentLoaded", () => {
  const ciclo = document.getElementById("ciclo");
  const nivel = document.getElementById("nivel");
  const buscar = document.getElementById("buscar");
  const filas = document.querySelectorAll(".asignar-table tbody tr");

  // üîπ Funci√≥n para limpiar texto: min√∫sculas + sin tildes
  function limpiarTexto(texto) {
    return texto
      .toLowerCase()
      .normalize("NFD")                // separa letras y acentos
      .replace(/[\u0300-\u036f]/g, ""); // elimina los acentos
  }

  // --- Aplicar filtros ---
  function aplicarFiltros() {
    const cicloVal = limpiarTexto(ciclo.value.trim());
    const nivelVal = limpiarTexto(nivel.value.trim());
    const query = limpiarTexto(buscar.value.trim());

    filas.forEach(fila => {
      const textoFila = limpiarTexto(fila.innerText);
      const cicloCelda = limpiarTexto(fila.children[1]?.innerText || "");
      const nivelCelda = limpiarTexto(fila.children[2]?.innerText || "");

      const coincideCiclo = !cicloVal || cicloCelda.includes(cicloVal);
      const coincideNivel = !nivelVal || nivelCelda.includes(nivelVal);
      const coincideBusqueda = !query || textoFila.includes(query);

      fila.style.display = (coincideCiclo && coincideNivel && coincideBusqueda) ? "" : "none";
    });
  }

  // --- Eventos ---
  ciclo.addEventListener("change", aplicarFiltros);
  nivel.addEventListener("change", aplicarFiltros);
  buscar.addEventListener("input", aplicarFiltros);

  // --- Ciclo actual seleccionado por defecto ---
  const currentYear = new Date().getFullYear().toString();
  const currentOption = Array.from(ciclo.options).find(opt => opt.text.trim() === currentYear);
  if (currentOption && !ciclo.value) {
    ciclo.value = currentOption.value;
    aplicarFiltros();
  }
});
</script>
{% endblock %}

