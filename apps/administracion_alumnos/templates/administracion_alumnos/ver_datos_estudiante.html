{% extends 'base.html' %}
{% load static %}

{% block title %}Ficha del Estudiante{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'administracion_alumnos/css/styles_ver_datos.css' %}">
{% endblock %}

{% block content %}
<div class="student-card">

  <!-- CABECERA -->
  <div class="student-header">
    <img src="{{ image_url }}" alt="Foto del Estudiante" class="student-photo">
    <div class="student-info">
      <h2>{{ estudiante.apellidos_estudiante }}, {{ estudiante.nombres_estudiante }}</h2>
      <p><strong>DNI:</strong> {{ estudiante.dni_estudiante }}</p>
      <p><strong>CUIL:</strong> {{ estudiante.cuil_estudiante }}</p>
    </div>
  </div>

  <!-- BOTONES -->
  <div class="student-actions">
    <a href="{% url 'generar_pdf_estudiante' estudiante_id=estudiante.id %}" class="btn">Generar PDF</a>
    <button type="button" id="btnDescargarArchivos" class="btn">Archivos</button>
    <a href="{% url 'estudiante_edit' pk=estudiante.id %}" class="btn">Editar</a>
      {% if estudiante.estado_documentacion.estado|lower == 'pendiente' %}
        <button type="button" class="btn btn-success" id="abrirModalEstado"
                data-accion="aprobar" data-color="success" data-nuevo="aprobado">
          Aprobar Doc.
        </button>
      {% elif estudiante.estado_documentacion.estado|lower == 'aprobado' %}
        <button type="button" class="btn btn-warning" id="abrirModalEstado"
                data-accion="marcar como pendiente" data-color="warning" data-nuevo="pendiente">
          Marcar Pendiente
        </button>
      {% endif %}
    <a href="{% url 'estudiante_list' %}" class="btn btn-light">Volver</a>
  </div>

  <!-- PESTAÑAS -->
  <div class="tabs">
    <button type="button" class="tab-button active" data-tab="datos">Datos Personales</button>
    <button type="button" class="tab-button" data-tab="inscripcion">Inscripción</button>
    <button type="button" class="tab-button" data-tab="academica">Académica</button>
    <button type="button" class="tab-button" data-tab="contacto">Contacto</button>
    <button type="button" class="tab-button" data-tab="salud">Salud</button>
    <button type="button" class="tab-button" data-tab="responsables">Responsables</button>
    <button type="button" class="tab-button" data-tab="documentacion">Documentación</button>
    <button type="button" class="tab-button" data-tab="cuotas">Cuotas</button>
    <button type="button" class="tab-button" data-tab="estado">Estado Doc.</button>
  </div>

  <!-- ===== DATOS PERSONALES ===== -->
  <div class="tab-content active" id="tab-datos">
    <table>
      <tr><th>Apellidos</th><td>{{ estudiante.apellidos_estudiante }}</td></tr>
      <tr><th>Nombres</th><td>{{ estudiante.nombres_estudiante }}</td></tr>
      <tr><th>Sexo</th><td>{{ estudiante.sexo_estudiante }}</td></tr>
      <tr><th>Fecha de Nacimiento</th><td>{{ estudiante.fecha_nac_estudiante }}</td></tr>
      <tr><th>Nacionalidad</th><td>{{ estudiante.nacionalidad_estudiante }}</td></tr>
      <tr><th>Religión</th><td>{{ estudiante.religion_estudiante }}</td></tr>
      <tr><th>CUIL</th><td>{{ estudiante.cuil_estudiante }}</td></tr>
      <tr><th>DNI</th><td>{{ estudiante.dni_estudiante }}</td></tr>
    </table>
  </div>

  <!-- ===== INSCRIPCIÓN ===== -->
  <div class="tab-content" id="tab-inscripcion">
    {% if estudiante.inscripcion %}
    <table>
      <tr><th>Marca Temporal</th><td>{{ estudiante.inscripcion.marca_temporal }}</td></tr>
      <tr><th>Email Registro</th><td>{{ estudiante.inscripcion.email_registro }}</td></tr>
      <tr><th>Foto</th><td>{{ estudiante.inscripcion.foto_estudiante }}</td></tr>
      <tr><th>N° Legajo</th><td>{{ estudiante.inscripcion.num_legajo_estudiante }}</td></tr>
      <tr><th>Fecha Recepción</th><td>{{ estudiante.inscripcion.fecha_recepcion }}</td></tr>
      <tr><th>Salita / Grado / Año</th><td>{{ estudiante.inscripcion.salita_grado_anio_estudiante }}</td></tr>
      <tr><th>Nivel</th><td>{{ estudiante.inscripcion.nivel_estudiante }}</td></tr>
      <tr><th>Curso / Año</th><td>{{ estudiante.inscripcion.curso_anio_estudiante }}</td></tr>
      <tr><th>Turno</th><td>{{ estudiante.inscripcion.turno_estudiante }}</td></tr>
      <tr><th>Nivel de Enseñanza</th><td>{{ estudiante.inscripcion.nivel_ensenanza }}</td></tr>
    </table>
    {% else %}
    <p>No hay datos de inscripción.</p>
    {% endif %}
  </div>

  <!-- ===== INFORMACIÓN ACADÉMICA ===== -->
  <div class="tab-content" id="tab-academica">
    {% if estudiante.info_academica %}
    <table>
      <tr><th>Año Cursado</th><td>{{ estudiante.info_academica.anio_cursado }}</td></tr>
      <tr><th>Dónde Cursó</th><td>{{ estudiante.info_academica.donde_cursado }}</td></tr>
      <tr><th>Asignaturas Pendientes</th><td>{{ estudiante.info_academica.asignaturas_pendientes }}</td></tr>
      <tr><th>Indica Cuáles</th><td>{{ estudiante.info_academica.indica_asig_pendientes }}</td></tr>
      <tr><th>Tiene Hermanos en la Institución</th><td>{{ estudiante.info_academica.tiene_hermanos_institucion }}</td></tr>
      <tr><th>Cuántos Hermanos</th><td>{{ estudiante.info_academica.cuantos_hermanos }}</td></tr>
      <tr><th>Cómo conoció la institución</th><td>{{ estudiante.info_academica.como_conociste_institucion }}</td></tr>
      <tr><th>Quién eligió la institución</th><td>{{ estudiante.info_academica.eligio_institucion }}</td></tr>
    </table>
    {% else %}
    <p>No hay información académica.</p>
    {% endif %}
  </div>

  <!-- ===== CONTACTO ===== -->
  <div class="tab-content" id="tab-contacto">
    {% if estudiante.contacto %}
    <table>
      <tr><th>Ciudad</th><td>{{ estudiante.contacto.ciudad_estudiante }}</td></tr>
      <tr><th>Provincia</th><td>{{ estudiante.contacto.provincia_estudiante }}</td></tr>
      <tr><th>Barrio</th><td>{{ estudiante.contacto.barrio_estudiante }}</td></tr>
      <tr><th>Calle</th><td>{{ estudiante.contacto.calle_estudiante }}</td></tr>
      <tr><th>N° / Mz / Pc</th><td>{{ estudiante.contacto.n_mz_pc_estudiante }}</td></tr>
      <tr><th>Código Postal</th><td>{{ estudiante.contacto.codigo_postal_estudiante }}</td></tr>
      <tr><th>Email</th><td>{{ estudiante.contacto.email_estudiante }}</td></tr>
      <tr><th>Tel. Fijo</th><td>{{ estudiante.contacto.tel_fijo_estudiante }}</td></tr>
      <tr><th>Tel. Celular</th><td>{{ estudiante.contacto.tel_cel_estudiante }}</td></tr>
      <tr><th>Tel. Emergencia</th><td>{{ estudiante.contacto.tel_emergencia_estudiante }}</td></tr>
      <tr><th>Parentesco</th><td>{{ estudiante.contacto.parentesco_estudiante }}</td></tr>
    </table>
    {% else %}
    <p>No hay datos de contacto.</p>
    {% endif %}
  </div>

  <!-- ===== SALUD ===== -->
  <div class="tab-content" id="tab-salud">
    {% if estudiante.salud %}
    <table>
      <tr><th>Peso</th><td>{{ estudiante.salud.peso_estudiante }}</td></tr>
      <tr><th>Talla</th><td>{{ estudiante.salud.talla_estudiante }}</td></tr>
      <tr><th>Obra Social</th><td>{{ estudiante.salud.obra_social_estudiante }}</td></tr>
      <tr><th>Cuál</th><td>{{ estudiante.salud.cual_osocial_estudiante }}</td></tr>
      <tr><th>Problema Neurológico</th><td>{{ estudiante.salud.problema_neurologico_estudiante }}</td></tr>
      <tr><th>Cuál</th><td>{{ estudiante.salud.cual_prob_neurologico_estudiante }}</td></tr>
      <tr><th>Problema Físico</th><td>{{ estudiante.salud.problema_fisico_estudiante }}</td></tr>
      <tr><th>Certificado Médico</th><td>{{ estudiante.salud.certificado_medico_estudiante }}</td></tr>
      <tr><th>Problema de Aprendizaje</th><td>{{ estudiante.salud.problema_aprendizaje_estudiante }}</td></tr>
      <tr><th>Cuál</th><td>{{ estudiante.salud.cual_aprendizaje_estudiante }}</td></tr>
      <tr><th>Atención Médica</th><td>{{ estudiante.salud.atencion_medica_estudiante }}</td></tr>
      <tr><th>Alergias</th><td>{{ estudiante.salud.alergia_estudiante }}</td></tr>
    </table>
    {% else %}
    <p>No hay datos de salud.</p>
    {% endif %}
  </div>

  <!-- ===== RESPONSABLES ===== -->
  <div class="tab-content" id="tab-responsables">
    {% if estudiante.responsables.all %}
    {% for r in estudiante.responsables.all %}
    <h4>{{ r.apellidos }}, {{ r.nombres }}</h4>
    <table>
      <tr><th>DNI</th><td>{{ r.dni }}</td></tr>
      <tr><th>CUIL</th><td>{{ r.cuil }}</td></tr>
      <tr><th>Nacionalidad</th><td>{{ r.nacionalidad }}</td></tr>
      <tr><th>Fecha de Nacimiento</th><td>{{ r.fecha_nac }}</td></tr>
      <tr><th>Estado Civil</th><td>{{ r.estado_civil }}</td></tr>
      <tr><th>Nivel de Instrucción</th><td>{{ r.nivel_instruccion }}</td></tr>
      <tr><th>Religión</th><td>{{ r.religion }}</td></tr>
      <tr><th>Email</th><td>{{ r.email }}</td></tr>
      <tr><th>Tel. Fijo</th><td>{{ r.tel_fijo }}</td></tr>
      <tr><th>Tel. Celular</th><td>{{ r.tel_cel }}</td></tr>
      <tr><th>Tel. Laboral</th><td>{{ r.tel_laboral }}</td></tr>
      <tr><th>Horario de Trabajo</th><td>{{ r.horario_trabajo }}</td></tr>
      <tr><th>Ocupación</th><td>{{ r.ocupacion }}</td></tr>
      <tr><th>Domicilio</th><td>{{ r.calle }} {{ r.n_mz_pc }}, {{ r.barrio }} - {{ r.ciudad }} ({{ r.codigo_postal }}), {{ r.provincia }}</td></tr>
    </table>
    <hr>
    {% endfor %}
    {% else %}
    <p>No hay responsables cargados.</p>
    {% endif %}
  </div>

  <!-- ===== DOCUMENTACIÓN ===== -->
  <div class="tab-content" id="tab-documentacion">
    {% if estudiante.documentacion %}
    <table>
      <tr><th>Fecha Contrato</th><td>{{ estudiante.documentacion.fecha_contrato }}</td></tr>
      <tr><th>Ciudad a los Días</th><td>{{ estudiante.documentacion.ciudad_a_los_dias }}</td></tr>
      <tr><th>Señores 1</th><td>{{ estudiante.documentacion.senores1 }} (DNI {{ estudiante.documentacion.dni_senores1 }})</td></tr>
      <tr><th>Señores 2</th><td>{{ estudiante.documentacion.senores2 }} (DNI {{ estudiante.documentacion.dni_senores2 }})</td></tr>
      <tr><th>Domicilios Señores</th><td>{{ estudiante.documentacion.domicilios_senores }}</td></tr>
      <tr><th>Domicilio Especial Electrónico</th><td>{{ estudiante.documentacion.domicilio_especial_electronico }}</td></tr>
      <tr><th>Actúan en nombre del Estudiante</th><td>{{ estudiante.documentacion.actuan_nombres_estudiante }} (DNI {{ estudiante.documentacion.dni_acutan_estudiante }})</td></tr>
      <tr><th>Domicilio de quien Actúa</th><td>{{ estudiante.documentacion.domicilio_actuan_estudiante }}</td></tr>
      <tr><th>Responsable de Pago</th><td>{{ estudiante.documentacion.responsable_pago }} (DNI {{ estudiante.documentacion.dni_responsable_pago }})</td></tr>
      <tr><th>Manifiesta Responsable</th><td>{{ estudiante.documentacion.manifiesta_responsable }}</td></tr>
      <tr><th>Autoriza Facturación a</th><td>{{ estudiante.documentacion.autoriza_facturacion_a }}</td></tr>
      <tr><th>Autoriza Imagen</th><td>{{ estudiante.documentacion.autoriza_imagen }}</td></tr>
    </table>
    {% else %}
    <p>No hay documentación registrada.</p>
    {% endif %}
  </div>

  <!-- ===== CUOTAS ===== -->
  <div class="tab-content" id="tab-cuotas">
    <p>Contenido de cuotas próximamente...</p>
  </div>

  <!-- ===== ESTADO DE DOCUMENTACIÓN ===== -->
  <div class="tab-content" id="tab-estado">
    {% if estudiante.estado_documentacion %}
    <div class="status {{ estudiante.estado_documentacion.estado|lower }}">
      <strong>Estado de Documentación:</strong> {{ estudiante.estado_documentacion.estado }}<br>
      <span>Última actualización: {{ estudiante.estado_documentacion.fecha_actualizacion|date:"d/m/Y H:i" }}</span>
    </div>
    {% else %}
    <p>No hay estado de documentación registrado.</p>
    {% endif %}
  </div>
</div>

<!-- MODAL CONFIRMACIÓN -->
<div id="modalEstado" class="modal">
  <div class="modal-content">
    <h3 id="modalTitulo">Confirmar acción</h3>
    <p id="modalTexto">
      ¿Seguro que deseas realizar esta acción?
    </p>
    <div class="modal-actions">
      <form id="modalForm" method="post" action="">
        {% csrf_token %}
        <button type="submit" id="modalBoton" class="btn">
          <i class="fas fa-check"></i> Confirmar
        </button>
      </form>
      <button type="button" class="btn btn-light" id="cerrarModalEstado">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL DESCARGA -->
<div id="modalDescarga" class="modal">
  <div class="modal-content">
    <h3>📂 Descarga completada</h3>
    <p id="textoDescarga">Procesando descarga...</p>
    <div class="modal-actions">
      <button type="button" class="btn btn-light" id="cerrarModalDescarga">Cerrar</button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Pestañas
  const tabButtons = document.querySelectorAll(".tab-button");
  const tabContents = document.querySelectorAll(".tab-content");
  tabButtons.forEach(button => {
    button.addEventListener("click", () => {
      const tabId = button.getAttribute("data-tab");
      tabButtons.forEach(btn => btn.classList.remove("active"));
      tabContents.forEach(tab => tab.classList.remove("active"));
      button.classList.add("active");
      document.getElementById("tab-" + tabId).classList.add("active");
    });
  });

  // Modal
  const modal = document.getElementById("modalEstado");
  const abrir = document.getElementById("abrirModalEstado");
  const cerrar = document.getElementById("cerrarModalEstado");
  const modalTitulo = document.getElementById("modalTitulo");
  const modalTexto = document.getElementById("modalTexto");
  const modalBoton = document.getElementById("modalBoton");
  const modalForm = document.getElementById("modalForm");

  if (abrir && modal && cerrar) {
    abrir.addEventListener("click", () => {
      const accion = abrir.dataset.accion;
      const color = abrir.dataset.color;
      const nuevo = abrir.dataset.nuevo;

      modalTitulo.textContent = "Confirmar " + accion.charAt(0).toUpperCase() + accion.slice(1);
      modalTexto.innerHTML = `¿Seguro que deseas <strong>${accion}</strong> la documentación de <strong>{{ estudiante.apellidos_estudiante }}, {{ estudiante.nombres_estudiante }}</strong>?`;
      modalBoton.className = `btn btn-${color}`;
      modalBoton.innerHTML = `<i class="fas fa-check"></i> Sí, ${accion}`;
      modalForm.action = `{% url 'cambiar_estado_documentacion' estudiante.id %}`;

      modal.style.display = "flex";
    });

    cerrar.addEventListener("click", () => modal.style.display = "none");
    window.addEventListener("click", e => {
      if (e.target === modal) modal.style.display = "none";
    });
  }
});

// 🔹 Descarga de archivos con AJAX + modal
const btnDescargar = document.getElementById("btnDescargarArchivos");
const modalDescarga = document.getElementById("modalDescarga");
const textoDescarga = document.getElementById("textoDescarga");
const cerrarModalDescarga = document.getElementById("cerrarModalDescarga");

if (btnDescargar) {
  btnDescargar.addEventListener("click", async () => {
    textoDescarga.textContent = "Descargando archivos...";
    modalDescarga.style.display = "flex";

    try {
      const response = await fetch("{% url 'descargar_archivos_alumnos' %}", {
        method: "GET",
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });

      const data = await response.json();

      textoDescarga.innerHTML = `
        ${data.mensaje}<br>
        <small>${data.descargados.length} descargados</small>
        ${data.omitidos.length ? `<br><small>${data.omitidos.length} omitidos</small>` : ""}
      `;
    } catch (error) {
      textoDescarga.textContent = "❌ Error al descargar archivos.";
    }
  });
}

if (cerrarModalDescarga) {
  cerrarModalDescarga.addEventListener("click", () => modalDescarga.style.display = "none");
  window.addEventListener("click", e => { if (e.target === modalDescarga) modalDescarga.style.display = "none"; });
}

</script>

{% endblock %}
