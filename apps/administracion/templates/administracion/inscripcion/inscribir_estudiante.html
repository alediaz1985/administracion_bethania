{% extends 'base.html' %}
{% load static %}

{% block title %}Inscripci√≥n Administrativa{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'administracion/css/inscribir/styles_inscripcion_adm.css' %}">
{% endblock %}

{% block content %}
<div class="student-card">

  <!-- üîπ Cabecera -->
  <div class="inscripcion-header">
    <h2>Inscripci√≥n Administrativa</h2>
    <p class="subtitle">Verificaci√≥n de datos del estudiante antes de registrar la inscripci√≥n.</p>
  </div>

  <!-- üîî Mensajes del sistema -->
  {% if messages %}
    <div class="mensajes-sistema">
      {% for message in messages %}
        <div class="mensaje {{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- üßç Datos del Estudiante -->
  <div class="datos-estudiante">
    <h3>Datos del Estudiante</h3>
    <div class="grid-datos">
      <div class="campo">
        <span class="label">Apellidos:</span>
        <span class="valor">{{ estudiante.apellidos_estudiante }}</span>
      </div>
      <div class="campo">
        <span class="label">Nivel:</span>
        {% if estudiante.inscripcion %}
          <span class="valor">{{ estudiante.inscripcion.nivel_estudiante }}</span>
        {% else %}
          <span class="valor">‚Äî</span>
        {% endif %}
      </div>

      <div class="campo">
        <span class="label">Nombres:</span>
        <span class="valor">{{ estudiante.nombres_estudiante }}</span>
      </div>
      <div class="campo">
        <span class="label">Curso / A√±o:</span>
        {% if estudiante.inscripcion %}
          <span class="valor">{{ estudiante.inscripcion.curso_anio_estudiante }}</span>
        {% else %}
          <span class="valor">‚Äî</span>
        {% endif %}
      </div>

      <div class="campo">
        <span class="label">CUIL:</span>
        <span class="valor">{{ estudiante.cuil_estudiante }}</span>
      </div>
      <div class="campo">
        <span class="label">Turno:</span>
        {% if estudiante.inscripcion %}
          <span class="valor">{{ estudiante.inscripcion.turno_estudiante }}</span>
        {% else %}
          <span class="valor">‚Äî</span>
        {% endif %}
      </div>
    </div>

    {% if not estudiante.inscripcion %}
    <p class="no-inscripcion">
      ‚ö†Ô∏è Este estudiante a√∫n no posee datos acad√©micos registrados.
    </p>
    {% endif %}
  </div>

  <!-- üßæ Estado de documentaci√≥n -->
  <div class="estado-doc">
    {% if estado_doc %}
      {% if estado_doc.estado|lower == 'aprobado' %}
        <p class="estado-aprobado">‚úÖ Documentaci√≥n aprobada ‚Äî El estudiante puede ser inscripto.</p>
      {% else %}
        <p class="estado-pendiente">‚ö†Ô∏è Documentaci√≥n pendiente ‚Äî No puede inscribirse a√∫n.</p>
      {% endif %}
    {% else %}
      <p class="estado-pendiente">‚ö†Ô∏è No se encontr√≥ informaci√≥n de documentaci√≥n.</p>
    {% endif %}
  </div>

  <!-- üìã Formulario de Inscripci√≥n -->
  {% if puede_inscribir %}
  <div class="registro-container">
    <div class="form-inscripcion">
      <h3>Registrar Inscripci√≥n</h3>
      <form method="post">
        {% csrf_token %}

        <table class="tabla-datos">
          <tr>
            <th>Ciclo Lectivo:</th>
            <td>
              <select name="ciclo" required>
                <option value="">Seleccione...</option>
                {% for ciclo in ciclos %}
                  <option value="{{ ciclo.id }}">{{ ciclo.anio }}</option>
                {% endfor %}
              </select>
            </td>
          </tr>
          <tr>
            <th>Nivel:</th>
            <td>
              <select name="nivel" required>
                <option value="">Seleccione...</option>
                {% for nivel in niveles %}
                  <option value="{{ nivel.id }}">{{ nivel.nombre }}</option>
                {% endfor %}
              </select>
            </td>
          </tr>
          <tr>
            <th>Subnivel:</th>
            <td>
              <select name="subnivel" required>
                <option value="">Seleccione...</option>
                {% for subnivel in subniveles %}
                  <option value="{{ subnivel.id }}">{{ subnivel.nombre }}</option>
                {% endfor %}
              </select>
            </td>
          </tr>
          <tr>
            <th>Turno:</th>
            <td>
              <select name="turno" required>
                <option value="">Seleccione...</option>
                <option value="Ma√±ana">Ma√±ana</option>
                <option value="Tarde">Tarde</option>
              </select>
            </td>
          </tr>
          <tr>
            <th>Beca (opcional):</th>
            <td>
              <select name="beca">
                <option value="">Sin beca</option>
                {% for beca in becas %}
                  <option value="{{ beca.id }}">{{ beca.nombre }} - {{ beca.tipo }} {{ beca.valor }}</option>
                {% endfor %}
              </select>
            </td>
          </tr>
          <tr>
            <th>Observaciones:</th>
            <td><textarea name="observaciones" rows="3"></textarea></td>
          </tr>
        </table>

        <div class="student-actions">
          <button type="submit" class="btn-inscribir">Inscribir</button>
        </div>
      </form>
    </div>
    <!-- üí∞ Columna Derecha: Montos din√°micos -->
    <div class="montos-container">
      <h3>Montos del Nivel Seleccionado</h3>
      <div class="montos-info">
        <p><strong>Monto de Inscripci√≥n:</strong> <span id="monto-inscripcion">‚Äî</span></p>
        <p><strong>Monto de Cuotas:</strong> <span id="monto-cuota">‚Äî</span></p>
        <p><strong>Beca asignada:</strong> <span id="monto-beca">‚Äî</span></p>
        <p class="total"><strong>Total de las cuotas:</strong> <span id="monto-total">‚Äî</span></p>
      </div>
      <div id="alerta-beca" class="alerta-beca">
        ‚ö†Ô∏è El monto de la beca supera o iguala el valor de la cuota mensual.
        <br>Por favor, revise la configuraci√≥n de la beca.
      </div>
    </div>
  </div>  
  {% endif %}

  <!-- üîò Volver -->
  <div class="student-actions">
    <a href="{% url 'ver_datos_estudiante' estudiante.id %}" class="btn-light">Volver</a>
  </div>

</div>

{{ montos_json|json_script:"montos-json" }}

<script>
document.addEventListener('DOMContentLoaded', function () {
  let montosData = [];

  try {
    montosData = JSON.parse(document.getElementById('montos-json').textContent);
  } catch (err) {
    console.error('‚ùå Error parseando JSON:', err);
  }

  console.log('‚úÖ montosData:', montosData, Array.isArray(montosData));

  const cicloSelect = document.querySelector('select[name="ciclo"]');
  const nivelSelect = document.querySelector('select[name="nivel"]');
  const becaSelect  = document.querySelector('select[name="beca"]');

  const spanInscripcion = document.getElementById('monto-inscripcion');
  const spanCuota       = document.getElementById('monto-cuota');
  const spanBeca        = document.getElementById('monto-beca');
  const spanTotal       = document.getElementById('monto-total');

  let cuotaBase = 0;

  const formatear = (v) => `$${Number(v).toLocaleString('es-AR', { minimumFractionDigits: 2 })}`;

  function limpiar() {
    spanInscripcion.textContent = '‚Äî';
    spanCuota.textContent = '‚Äî';
    spanBeca.textContent = '‚Äî';
    spanTotal.textContent = '‚Äî';
  }

  function actualizarMontos() {
    const cicloId = parseInt(cicloSelect.value);
    const nivelId = parseInt(nivelSelect.value);

    if (isNaN(cicloId) || isNaN(nivelId)) {
      limpiar();
      return;
    }

    console.log('üîç Buscando ciclo:', cicloId, 'nivel:', nivelId);

    const monto = montosData.find(m => m.ciclo_id === cicloId && m.nivel_id === nivelId);

    if (!monto) {
      limpiar();
      return;
    }

    cuotaBase = Number(monto.monto_cuota);
    spanInscripcion.textContent = formatear(monto.monto_inscripcion);
    spanCuota.textContent = formatear(cuotaBase);

    calcularConBeca();
  }

  function calcularConBeca() {
    const becaTexto = becaSelect.options[becaSelect.selectedIndex]?.textContent || '';
    const alertaDiv = document.getElementById('alerta-beca');

    if (cuotaBase === 0) {
      limpiar();
      if (alertaDiv) alertaDiv.style.display = 'none';
      return;
    }

    let descuento = 0;
    if (becaTexto.includes('Porcentaje')) {
      const p = parseFloat(becaTexto.replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
      descuento = cuotaBase * (p / 100);
    } else if (becaTexto.includes('Monto fijo')) {
      descuento = parseFloat(becaTexto.replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
    }

    const total = Math.max(cuotaBase - descuento, 0);
    spanBeca.textContent = descuento ? `-${formatear(descuento)}` : '‚Äî';
    spanTotal.textContent = formatear(total);

    // ‚ö†Ô∏è Mostrar alerta si la beca es mayor o igual a la cuota
    if (descuento >= cuotaBase && descuento > 0) {
      alertaDiv.style.display = 'block';
    } else {
      alertaDiv.style.display = 'none';
    }
  }

  cicloSelect.addEventListener('change', actualizarMontos);
  nivelSelect.addEventListener('change', actualizarMontos);
  becaSelect.addEventListener('change', calcularConBeca);
});
</script>

{% endblock %}
