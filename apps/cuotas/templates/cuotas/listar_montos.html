{% extends 'base.html' %}

{% block title %}Listado de Montos del Ciclo Lectivo{% endblock %}

{% load static %}

{% block extra_styles %}
    <link rel="stylesheet" href="{% static 'cuotas/css/lista-montos.css' %}">
{% endblock %}

{% block content %}

<section class="montos">
    <div class="montos__contenedor">
        <h1 class="montos__titulo">Listado de Montos del Ciclo Lectivo</h1>

        <a href="{% url 'cuotas:generar_pdf_montos' %}" class="montos__boton-descarga">
            Descargar Listado de Montos
        </a>

        <div class="filters">
            <!-- Filtro 1: Ciclo Lectivo -->
            <select id="filtro-ciclo">
                <option value="">Todos los Ciclos Lectivos</option>
                {% for monto in montos|dictsort:"ciclo_lectivo.año_lectivo" %}
                    {% ifchanged monto.ciclo_lectivo.año_lectivo %}
                        <option value="{{ monto.ciclo_lectivo.año_lectivo }}">{{ monto.ciclo_lectivo.año_lectivo }}</option>
                    {% endifchanged %}
                {% endfor %}
            </select>
        
            <!-- Filtro 2: Subnivel -->
            <select id="filtro-subnivel">
                <option value="">Todos los Subniveles</option>
                {% for monto in montos|dictsort:"subnivel_cursado.nombre" %}
                    {% ifchanged monto.subnivel_cursado.nombre %}
                        <option value="{{ monto.subnivel_cursado.nombre }}">{{ monto.subnivel_cursado.nombre }}</option>
                    {% endifchanged %}
                {% endfor %}
            </select>
        </div>

        <table class="montos__tabla">
            <thead class="montos__encabezado">
                <tr class="montos__fila-encabezado">
                    <th class="montos__celda-encabezado">Ciclo Lectivo</th>
                    <th class="montos__celda-encabezado">Subnivel</th>
                    <th class="montos__celda-encabezado">Tipo de Monto</th>
                    <th class="montos__celda-encabezado">Monto</th>
                    <th class="montos__celda-encabezado">Fecha de Actualización</th>
                </tr>
            </thead>
            <tbody class="montos__cuerpo">
                {% for monto in montos %}
                    {% if forloop.first or previous_ciclo_lectivo != monto.ciclo_lectivo.año_lectivo %}
                        <tr class="montos__fila montos__fila--agrupada">
                            <td class="montos__celda" rowspan="2">{{ monto.ciclo_lectivo.año_lectivo }}</td>
                            <td class="montos__celda" rowspan="2">{{ monto.subnivel_cursado.nombre }}</td>
                            <td class="montos__celda"><strong>Inscripción</strong></td>
                            <td class="montos__celda">${{ monto.monto_inscripcion }}</td>
                            <td class="montos__celda">{{ monto.fecha_actualizacion }}</td>
                        </tr>
                    {% endif %}
                    <tr class="montos__fila">
                        <td class="montos__celda"><strong>Cuota Mensual</strong></td>
                        <td class="montos__celda">${{ monto.monto_cuota_mensual }}</td>
                        <td class="montos__celda">{{ monto.fecha_actualizacion }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const filtroCiclo = document.getElementById("filtro-ciclo");
        const filtroSubnivel = document.getElementById("filtro-subnivel");
        const filas = document.querySelectorAll(".montos__cuerpo tr");

        function filtrarTabla() {
            const valorCiclo = filtroCiclo.value.toLowerCase();
            const valorSubnivel = filtroSubnivel.value.toLowerCase();

            let cicloActual = "";
            let subnivelActual = "";

            filas.forEach((fila, index) => {
                const celdas = fila.querySelectorAll("td");

                // Si es fila agrupada, actualizamos los valores actuales
                if (fila.classList.contains("montos__fila--agrupada")) {
                    cicloActual = celdas[0].textContent.trim().toLowerCase();
                    subnivelActual = celdas[1].textContent.trim().toLowerCase();
                }

                // Verificamos si debe mostrarse esta fila (según los valores actuales)
                const coincideCiclo = !valorCiclo || cicloActual === valorCiclo;
                const coincideSubnivel = !valorSubnivel || subnivelActual === valorSubnivel;

                if (coincideCiclo && coincideSubnivel) {
                    fila.style.display = "";
                } else {
                    fila.style.display = "none";
                }
            });
        }

        filtroCiclo.addEventListener("change", filtrarTabla);
        filtroSubnivel.addEventListener("change", filtrarTabla);
    });
</script>

{% endblock %}