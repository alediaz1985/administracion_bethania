{% extends 'base.html' %}
{% load static %}

{% block title %}Ciclos Lectivos{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'administracion/css/ciclo_lectivo/styles_ciclos_lectivos.css' %}">
{% endblock %}

{% block content %}
<div class="ciclos-container">

    <!-- ðŸ”¹ CABECERA -->
    <div class="ciclos-header">
      <div class="ciclos-titulo">
        <h2>Ciclos Lectivos</h2>
        <p class="subtitulo">Gestione los ciclos activos del sistema</p>
      </div>

      <div class="ciclos-botones">
        <!-- ðŸ”¸ BotÃ³n Volver -->
        <a href="{% url 'administracion:home_administracion' %}" class="btn-volver">
          Volver
        </a>

        <!-- ðŸ”¸ BotÃ³n Nuevo Ciclo -->
        <button class="btn-nuevo" id="btnAdd">
          Nuevo Ciclo
        </button>
      </div>
    </div>

  <!-- ðŸ”¹ TABLA -->
  <div id="tabla-ciclos" class="tabla-container">
    {% include 'administracion/ciclo_lectivo/_tabla.html' %}
  </div>
</div>

<!-- ðŸ”¹ MODAL -->
<div id="modalCiclo" class="modal fade" tabindex="-1"></div>
{% endblock %}

{% block extra_js %}
<script>
  function loadModal(url) {
    fetch(url)
      .then(r => r.json())
      .then(data => {
        const modalDiv = document.getElementById("modalCiclo");
        modalDiv.innerHTML = data.html_form;

        const modal = new bootstrap.Modal(modalDiv);
        modal.show();

        function handleSubmit(form) {
          form.addEventListener("submit", function (e) {
            e.preventDefault();
            fetch(url, { method: "POST", body: new FormData(form) })
              .then(r => r.json())
              .then(data => {
                if (data.form_is_valid) {
                  document.getElementById("tabla-ciclos").innerHTML = data.html_list;
                  modal.hide();
                } else {
                  modalDiv.innerHTML = data.html_form;
                  const newForm = modalDiv.querySelector("form");
                  if (newForm) handleSubmit(newForm);
                }
              });
          });
        }

        const form = modalDiv.querySelector("form");
        if (form) handleSubmit(form);
      });
  }

  document.getElementById("btnAdd").addEventListener("click", () => {
    loadModal("{% url 'administracion:crear_ciclo' %}");
  });

  document.addEventListener("click", (e) => {
    const editBtn = e.target.closest(".js-edit");
    const delBtn = e.target.closest(".js-delete");
    if (editBtn) loadModal(editBtn.dataset.url);
    if (delBtn) loadModal(delBtn.dataset.url);
  });
</script>
{% endblock %}
