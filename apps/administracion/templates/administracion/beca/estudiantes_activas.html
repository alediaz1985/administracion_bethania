{% extends 'base.html' %}
{% load static %}

{% block title %}Estudiantes con Becas{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'administracion/css/beca/styles_estudiantes_becas.css' %}">
{% endblock %}

{% block content %}
<div class="estudiantes-becas-container">

  <!-- 游댳 CABECERA -->
  <div class="estudiantes-header">
    <h2>Estudiantes con Becas</h2>

    <div class="estudiantes-botones">
      <a href="{% url 'administracion:lista_becas' %}" class="btn-volver">Volver</a>
      <a href="{% url 'administracion:asignar_beca_general' %}" class="btn-asignar-general">
        Asignar Becas
      </a>
    </div>
  </div>

  <!-- 游댳 FILTROS -->
  <form method="get" id="formFiltros" class="filtros-container mb-3">
    <div class="filtros-row">
      <!-- Ciclo -->
      <div class="filtro">
        <label for="ciclo">Ciclo</label>
        <select name="ciclo" id="ciclo" class="form-select form-select-sm">
          <option value="">Todos</option>
          {% for c in ciclos %}
            <option value="{{ c.id }}" {% if filtros.ciclo == c.id|stringformat:"s" %}selected{% endif %}>
              {{ c.anio }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Nivel -->
      <div class="filtro">
        <label for="nivel">Nivel</label>
        <select name="nivel" id="nivel" class="form-select form-select-sm">
          <option value="">Todos</option>
          {% for n in niveles %}
            <option value="{{ n.id }}" {% if filtros.nivel == n.id|stringformat:"s" %}selected{% endif %}>
              {{ n.nombre }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Beca -->
      <div class="filtro">
        <label for="beca">Beca</label>
        <select name="beca" id="beca" class="form-select form-select-sm">
          <option value="">Todas</option>
          {% for b in becas %}
            <option value="{{ b.id }}" {% if filtros.beca == b.id|stringformat:"s" %}selected{% endif %}>
              {{ b.nombre }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Buscador -->
      <div class="filtro filtro-buscar">
        <label for="q">Buscar</label>
        <input type="text" name="q" id="q" class="form-control form-control-sm"
              placeholder="Nombre o Apellido" value="{{ filtros.q|default:'' }}">
      </div>
    </div>
  </form>

  <!-- 游댳 MENSAJES -->
  {% if messages %}
    {% for msg in messages %}
      <div class="alert alert-{{ msg.tags }}">{{ msg }}</div>
    {% endfor %}
  {% endif %}

  <!-- 游댳 TABLA -->
  {% if inscripciones %}
    <table class="estudiantes-table">
      <thead>
        <tr>
          <th>Estudiante</th>
          <th>Ciclo</th>
          <th>Nivel</th>
          <th>Beca Actual</th>
          <th>Seleccionar Nueva</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for ins in inscripciones %}
        <tr>
          <td>{{ ins.estudiante.apellidos_estudiante }}, {{ ins.estudiante.nombres_estudiante }}</td>
          <td>{{ ins.ciclo.anio }}</td>
          <td>{{ ins.nivel.nombre }}</td>
          <td>
            {% if ins.beca %}
              <span class="{% if ins.beca.activa %}text-success{% else %}text-danger{% endif %}">
                {{ ins.beca.nombre }}
                {% if not ins.beca.activa %}(Inactiva){% endif %}
              </span>
            {% else %}
              <span class="text-muted">Sin beca</span>
            {% endif %}
          </td>

          <td class="col-select">
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="inscripcion_id" value="{{ ins.id }}">
              <select name="nueva_beca" class="form-select form-select-sm">
                <option value="">-- Seleccionar --</option>
                {% for b in becas %}
                  <option value="{{ b.id }}">{{ b.nombre }} ({{ b.tipo }} - {{ b.valor }})</option>
                {% endfor %}
              </select>
          </td>

          <td class="col-acciones">
              <button type="submit" name="accion" value="cambiar" class="icon-btn edit" title="Cambiar Beca">
                <i class="fas fa-sync-alt"></i>
              </button>

              <button type="button" class="icon-btn delete btn-confirmar-quitar"
                      data-inscripcion-id="{{ ins.id }}" title="Quitar Beca">
                <i class="fas fa-trash-alt"></i>
              </button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <div class="alert alert-info">
      No hay estudiantes con becas asignadas.
    </div>
  {% endif %}
</div>

<!-- 游 MODAL DE CONFIRMACI칍N (Quitar Beca) -->
<div class="modal fade" id="confirmarQuitarModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-custom">
    <div class="modal-content modal-confirm">
      <!-- 游댳 CABECERA -->
      <div class="modal-header">
        <h5 class="modal-title">Confirmar acci칩n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <!-- 游댳 CUERPO -->
      <div class="modal-body">
        <p>쮼st치s seguro de quitar la beca de este estudiante?</p>
      </div>

      <!-- 游댳 PIE -->
      <div class="modal-footer">
        <button type="button" class="btn-cancelar" data-bs-dismiss="modal">Cancelar</button>
        <form method="post" id="formConfirmarQuitar">
          {% csrf_token %}
          <input type="hidden" name="inscripcion_id" id="inputInscripcionQuitar">
          <input type="hidden" name="accion" value="quitar">
          <button type="submit" class="btn-eliminar">S칤, quitar</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  // --- Modal (se mantiene igual) ---
  const modalQuitar = new bootstrap.Modal(document.getElementById("confirmarQuitarModal"));
  const inputInscripcionQuitar = document.getElementById("inputInscripcionQuitar");

  document.querySelectorAll(".btn-confirmar-quitar").forEach(btn => {
    btn.addEventListener("click", () => {
      inputInscripcionQuitar.value = btn.dataset.inscripcionId;
      modalQuitar.show();
    });
  });

  // --- Filtros din치micos ---
  const ciclo = document.getElementById("ciclo");
  const nivel = document.getElementById("nivel");
  const beca = document.getElementById("beca");
  const searchInput = document.getElementById("q");
  const filas = document.querySelectorAll(".estudiantes-table tbody tr");

  // 游댳 Funci칩n para limpiar texto (min칰sculas + sin tildes)
  function limpiarTexto(texto) {
    return texto
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "");
  }

  function aplicarFiltros() {
    const cicloVal = ciclo.value.trim();
    const nivelVal = nivel.value.trim();
    const becaVal = beca.value.trim();
    const query = limpiarTexto(searchInput.value.trim());

    filas.forEach(fila => {
      const textoFila = limpiarTexto(fila.innerText);

      // verificamos que las celdas coincidan con los filtros
      const cicloCelda = fila.children[1]?.innerText.trim();
      const nivelCelda = fila.children[2]?.innerText.trim();
      const becaCelda = fila.children[3]?.innerText.trim();

      const coincideCiclo = !cicloVal || cicloCelda.includes(ciclo.options[ciclo.selectedIndex].text);
      const coincideNivel = !nivelVal || nivelCelda.includes(nivel.options[nivel.selectedIndex].text);
      const coincideBeca = !becaVal || becaCelda.includes(beca.options[beca.selectedIndex].text);
      const coincideBusqueda = !query || textoFila.includes(query);

      // mostrar/ocultar fila
      if (coincideCiclo && coincideNivel && coincideBeca && coincideBusqueda) {
        fila.style.display = "";
      } else {
        fila.style.display = "none";
      }
    });
  }

  // --- Eventos ---
  [ciclo, nivel, beca].forEach(sel => {
    sel.addEventListener("change", aplicarFiltros);
  });
  searchInput.addEventListener("input", aplicarFiltros);
});

// --- Seleccionar autom치ticamente el ciclo actual ---
document.addEventListener("DOMContentLoaded", () => {
  const cicloSelect = document.getElementById("ciclo");
  if (cicloSelect) {
    const currentYear = new Date().getFullYear().toString();

    // Buscar la opci칩n cuyo texto coincide con el a침o actual
    const currentOption = Array.from(cicloSelect.options).find(
      opt => opt.text.trim() === currentYear
    );

    // Si existe y no hay otro ciclo ya seleccionado, lo seleccionamos
    if (currentOption && !cicloSelect.value) {
      cicloSelect.value = currentOption.value;

      // Ejecutamos el filtrado inicial
      const event = new Event("change");
      cicloSelect.dispatchEvent(event);
    }
  }
});
</script>
{% endblock %}

